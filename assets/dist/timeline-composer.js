var Emoji_Picker={template:"#vxfeed__emoji-picker",emits:["select"],props:{composer:Object},data(){return{isOpen:!1,loading:!0,list:null,recents:[],search:{term:"",list:[]}}},methods:{open(){this.isOpen=!0,this.load()},load(){null===this.list&&jQuery.get(this.$root.config.settings.emojis.url).always(t=>{"object"!=typeof t?this.loading=!1:(this.loading=!1,this.list=t)});var t=localStorage.getItem("voxel:recent_emojis");"string"==typeof t&&(this.recents=[...t])},insert(e){this.$emit("select",e);let t=[];var s=localStorage.getItem("voxel:recent_emojis");(t=(t="string"==typeof s?[...s]:t).filter(t=>t!==e)).unshift(e),localStorage.setItem("voxel:recent_emojis",t.slice(0,16).join("")),this.recents=t.slice(0,16)},runSearch(){let e=[],s=!1;Object.values(this.list).forEach(t=>{s||t.forEach(t=>{s||-1!==t.name.toLowerCase().indexOf(this.search.term.trim().toLowerCase())&&(e.push(t.emoji),s=80<=e.length)})}),this.search.list=e}},watch:{"search.term"(){this.search.term.trim()&&this.list&&this.runSearch()}}},Composer_Mixin={components:{"emoji-picker":Emoji_Picker},data(){return{uniqueId:"vxfeed__composer-"+Voxel.helpers.sequentialId(),isFocused:!1,footerHeight:"",data:{content:"",files:[]},mentions:{show:!1,style:{top:null,left:null},caretOffset:null,query:{startIndex:null,endIndex:null,content:""},list:[],focused:0,lastRequest:null},refreshKey:0,isComposing:!1}},created(){this.queryMentions=Voxel.helpers.debounce(()=>{this.mentions.lastRequest?.abort();const e=this.mentions.query.content;this.mentions.lastRequest=jQuery.get(Voxel_Config.ajax_url+"&action=timeline/v2/mentions.search",{search:e,_wpnonce:this.$root.config.nonce}).always(t=>{t.success&&(this.mentions.list=t.users,this.mentions.focused=0,window._vx_mentions_cache[e]=t.users)})},200)},methods:{onInput(t){var e=this.$refs.textarea.selectionStart;"@"!==t.data||1!==e&&!/\s/.test(this.data.content[e-2])||(this.mentions.query.startIndex=e,this.mentions.query.endIndex=e,this.showMentions(e)),this.mentions.show&&(!(e>=this.mentions.query.startIndex&&e-this.mentions.query.startIndex<=32)||(this.mentions.query.endIndex=e,(t=this.data.content.substring(this.mentions.query.startIndex,e)).length&&!/^@[A-Za-z0-9._路@-]{1,63}$/g.test("@"+t))?this.hideMentions():2<=(this.mentions.query.content=t).length&&(Array.isArray(window._vx_mentions_cache[t])?(this.mentions.list=window._vx_mentions_cache[t],this.mentions.focused=0):this.queryMentions()))},onCompositionStart(){this.isComposing=!0},onCompositionUpdate(){requestAnimationFrame(()=>this.refreshKey++)},onCompositionEnd(){this.isComposing=!1},onScroll(t){var e=this.$refs.textarea,s=this.$refs.highlighter;s.scrollTop=e.scrollTop,s.scrollLeft=e.scrollLeft},showMentions(t){this.mentions.caretOffset=t,this.mentions.show=!0,this.mentions.list=[],this.repositionDropdown(),window.addEventListener("resize",()=>this.hideMentions(),{once:!0})},repositionDropdown(){this.mentions.show&&this.$nextTick(()=>{var t,e,s=this.getCaretPosition(this.mentions.caretOffset);null!==s&&(this.mentions.style.top=s.top+s.height+5+"px",t=this.$refs.mentions.offsetWidth,e=window.innerWidth,s.left+t>e?this.mentions.style.left=e-t+"px":this.mentions.style.left=s.left+"px")})},getCaretPosition(r){var t=this.$refs.highlighter;let a=0;const l=e=>{for(let t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(s.nodeType===Node.TEXT_NODE){var i,n=s.textContent.length;if(a+n>=r)return i=r-a,i=s.splitText(i),(o=document.createElement("span")).classList.add("hl-caret"),e.insertBefore(o,i),i=o.getBoundingClientRect(),o.remove(),{top:window.pageYOffset+i.top,left:window.pageXOffset+i.left,width:i.width,height:i.height};a+=n}else if(s.nodeType===Node.ELEMENT_NODE){var o=l(s);if(null!==o)return o}}return null};return l(t)},hideMentions(){this.mentions.show=!1},onKeydown(t){this.$refs.textarea,this.mentions.show&&("ArrowDown"===t.key?(t.preventDefault(),this.mentions.focused=Math.min(this.mentions.focused+1,this.mentions.list.length-1)):"ArrowUp"===t.key?(t.preventDefault(),this.mentions.focused=Math.max(this.mentions.focused-1,0)):"Enter"===t.key?(t.preventDefault(),this.$refs.mentions.querySelector("a.is-active")?.click()):"Escape"===t.key&&this.hideMentions()),"Tab"===t.key&&(t.preventDefault(),this.insertText("\t"))},selectMention(t){var{startIndex:e,endIndex:s}=this.mentions.query,i=this.$refs.textarea;i.focus(),i.setSelectionRange(e,s),document.execCommand("insertText",!1,t.username.replaceAll(" ","路")),this.hideMentions()},insertText(t){document.activeElement!==this.$refs.textarea&&this.$refs.textarea.focus(),document.execCommand("insertText",!1,t)},focus(){var t=this.$refs.textarea;t&&t.focus()}},computed:{highlightedContent(){this.refreshKey;let e=this.data.content;this.isComposing&&this.$refs.textarea&&(e=this.$refs.textarea.value),e=this.$root.escapeHTML(e);const s=[],i=t=>{var e=` {${Voxel.helpers.randomId(32)}} `;return s.push({id:e,content:t}),e};return e=(e=(e=(e=(e=e.replace(this.$root.RG_CODE_BLOCK,t=>i(t))).replace(this.$root.RG_INLINE_CODE,t=>i(t))).replace(this.$root.RG_USERNAME,(t,e,s)=>(s=s.replaceAll("路",'<span style="opacity:.3;">路</span>'),i(e+`<a href="#">${s}</a>`)))).replace(this.$root.RG_HASHTAG,(t,e,s)=>i(e+`<a href="#">${s}</a>`))).replace(this.$root.RG_REGULAR_LINK,e=>{try{new URL(e);return`<a href="#">${e}</a>`}catch(t){return e}}),s.forEach(t=>{e=e.replace(t.id,t.content)}),"\n"===e.at(-1)&&(e+=" "),e}}},Review_Score={template:"#vxfeed__review-score",emits:["update:modelValue"],props:{config:Object,modelValue:Object},data(){return{rating:this.modelValue}},methods:{setScore(t,e){this.isScoreSelected(t,e)?delete this.rating[t.key]:this.rating[t.key]=e.score},isScoreSelected(t,e){return this.rating[t.key]===e.score},isScoreCovered(t,e){t=this.rating[t.key];return"number"==typeof t&&t>=e.score},getActiveScore(t){t=this.rating[t.key];return[-2,-1,0,1,2].includes(t)?this.config.rating_levels[t+2]:null}},watch:{modelValue(t){this.rating=t}}},timelineComposer={template:"#vxfeed__composer",mixins:[Composer_Mixin],emits:["publish","update","cancel","mounted"],props:{status:{type:Object,default:null},quoteOf:{type:Object,default:null}},components:{"review-score":Review_Score},data(){return{submitting:!1,data:{content:"",files:[],rating:{}},isDragOver:!1}},created(){this.config=this.$root.config.composer,this.settings=this.$root.config.settings.posts,null!==this.status&&(this.data.content=this.status.content,this.data.files=structuredClone(Vue.toRaw(this.status.files)),"post_reviews"===this.status.feed)&&this.status.review&&(this.data.rating=structuredClone(Vue.toRaw(this.status.review.rating)))},mounted(){this.$nextTick(()=>this.$emit("mounted"))},methods:{onCancel(){this.status?this.status.content!==this.data.content?Voxel.prompt(this.$root.config.l10n.cancelEdit,"warning",[{label:Voxel_Config.l10n.yes,onClick:()=>this.$emit("cancel")},{label:Voxel_Config.l10n.no,onClick:()=>{}}],7500):this.$emit("cancel"):this.data.content.length||this.data.files.length?Voxel.prompt(this.$root.config.l10n.cancelEdit,"warning",[{label:Voxel_Config.l10n.yes,onClick:()=>this.$emit("cancel")},{label:Voxel_Config.l10n.no,onClick:()=>{}}],7500):this.$emit("cancel")},publish(){if(null!==this.status){this.submitting=!0;const e=new FormData,s=(this.$root.config,{status_id:this.status.id,content:this.data.content,files:[],rating:this.data.rating});this.data.files.forEach(t=>{"new_upload"===t.source?(e.append("files[timeline]",t.item),s.files.push("uploaded_file")):"existing"===t.source&&s.files.push(t.id)}),e.append("data",JSON.stringify(s)),e.append("_wpnonce",this.$root.config.nonce),jQuery.post({url:Voxel_Config.ajax_url+"&action=timeline/v2/status.edit",data:e,contentType:!1,processData:!1}).always(t=>{this.submitting=!1,t.success?(Voxel.alert(t.message,"success",null,3e3),this.$emit("update",t.status)):Voxel.alert(t.message||Voxel_Config.l10n.ajaxError,"error")})}else if(null!==this.quoteOf){this.submitting=!0;const i=new FormData,n=(this.$root.config,{status_id:this.quoteOf.id,content:this.data.content,files:[]});this.data.files.forEach(t=>{"new_upload"===t.source?(i.append("files[timeline]",t.item),n.files.push("uploaded_file")):"existing"===t.source&&n.files.push(t.id)}),i.append("data",JSON.stringify(n)),i.append("_wpnonce",this.$root.config.nonce),jQuery.post({url:Voxel_Config.ajax_url+"&action=timeline/v2/status.quote",data:i,contentType:!1,processData:!1}).always(t=>{this.submitting=!1,t.success?(Voxel.alert(t.message,"success",null,3e3),this.$emit("publish",t.status),this.reset()):Voxel.alert(t.message||Voxel_Config.l10n.ajaxError,"error")})}else{this.submitting=!0;const o=new FormData;var t=this.$root.config;const r={feed:t.composer.feed,post_id:t.current_post.id,content:this.data.content,files:[],rating:this.data.rating};this.data.files.forEach(t=>{"new_upload"===t.source?(o.append("files[timeline]",t.item),r.files.push("uploaded_file")):"existing"===t.source&&r.files.push(t.id)}),o.append("data",JSON.stringify(r)),o.append("_wpnonce",this.$root.config.nonce),jQuery.post({url:Voxel_Config.ajax_url+"&action=timeline/v2/status.publish",data:o,contentType:!1,processData:!1}).always(t=>{this.submitting=!1,t.success?(this.$emit("publish",t.status),this.reset()):Voxel.alert(t.message||Voxel_Config.l10n.ajaxError,"error")})}},reset(){this.data.content="",this.data.files=[],this.data.rating={}},onDragEnter(t){t.dataTransfer?.types?.includes("Files")&&this.settings.gallery_enabled&&(this.isDragOver=!0,this.isFocused=!0)},onDrop(t){this.isDragOver=!1,this.$refs.mediaUploader.onDrop(t)}},computed:{placeholder(){return(this.quoteOf?this.$root.config.settings.quotes:this.config).placeholder},avatarUrl(){var t=this.$root.config;return("current_user"===t.composer.post_as?t.current_user:t.current_post).avatar_url},isExpanded(){return!!(this.status||this.quoteOf||this.isFocused||this.data.content.length||this.data.files.length||"post_reviews"===this.config.feed&&Object.values(this.data.rating).some(t=>"number"==typeof t))},reviewConfig(){var t;return!this.quoteOf&&(!this.status||"post_reviews"===this.status.feed)&&(this.status||"post_reviews"===this.config.feed)?(t=this.$root.config.reviews,this.status&&this.status.review?t[this.status.review.post_type]:t[this.config.reviews_post_type]):null}}};export{timelineComposer as default};
