!function(e){"function"==typeof define&&define.amd?define("timelineMain",e):e()}(function(){"use strict";var o={template:"#vxfeed__feed",data(){return{page:1,loading:!0,hasMore:!1,list:[],search:{query:this.$root.config.settings.search.default_query},orderBy:{showList:!1,active:null},filterBy:{showList:!1,active:"all"},isSingle:!1,showFilters:!1}},created(){this.config=this.$root.config,this.config.settings.ordering_options.length&&(this.orderBy.active=this.config.settings.ordering_options[0]),null!==this.config.single_status_id||null!==this.config.single_reply_id?(this.isSingle=!0,this.getActiveStatus()):this.getFeed(),this.search.query&&(this.showFilters=!0)},methods:{getFeed(e={}){this.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline/v2/get_feed",{page:this.page,mode:this.config.timeline.mode,post_id:this.config.current_post.id,user_id:this.config.current_author.id,order_type:this.orderBy.active?.order||"latest",order_time:this.orderBy.active?.time||"all_time",order_time_custom:this.orderBy.active?.time_custom||null,filter_by:this.filterBy.active,search:this.search.query,_loaded_review_config:JSON.stringify(Object.keys(this.config.reviews))}).always(t=>{t.success?(this.list.push(...t.data),this.hasMore=t.has_more,"user_feed"===this.config.timeline.mode&&this.hasMore&&t.data.length<6&&!1!==e.autoloadNext&&(this.page++,this.getFeed({autoloadNext:!1})),this.list.length&&(this.showFilters=!0),t.meta&&Object.keys(t.meta.review_config).forEach(e=>{this.config.reviews[e]=t.meta.review_config[e]})):Voxel.alert(t.message||Voxel_Config.l10n.ajaxError,"error"),this.loading=!1})},getActiveStatus(){this.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline/v2/get_feed",{mode:"single_status",status_id:this.config.single_status_id,reply_id:this.config.single_reply_id,order_type:"latest",order_time:"all_time",_loaded_review_config:JSON.stringify(Object.keys(this.config.reviews))}).always(t=>{this.loading=!1,t.success?(this.list=[...t.data],this.hasMore=!1,t.meta&&Object.keys(t.meta.review_config).forEach(e=>{this.config.reviews[e]=t.meta.review_config[e]})):Voxel.alert(t.message||Voxel_Config.l10n.ajaxError,"error")})},loadMore(){this.page++,this.getFeed()},runSearch(e){e=e.target.value;e.trim()!==this.search.query&&(this.search.query=e.trim(),this.page=1,this.list=[],this.getFeed())},setActiveOrder(e){this.orderBy.showList=!1,e._id!==this.orderBy.active._id&&(this.page=1,this.list=[],this.orderBy.active=e,this.getFeed())},setActiveFilter(e){this.filterBy.showList=!1,e!==this.filterBy.active&&(this.page=1,this.list=[],this.filterBy.active=e,this.getFeed())},onPublish(e){this.list.unshift(e),this.$refs.composer.isFocused=!1},onQuote(e){var t,s;this.isSingle||("post_timeline"===(s=(t=this.$root.config).timeline.mode)?"post"===e.publisher.type&&e.publisher.id===t.current_post.id&&this.list.unshift(e):"author_timeline"===s?"user"===e.publisher.type&&e.publisher.id===t.current_author.id&&this.list.unshift(e):"user_feed"!==s&&"global_feed"!==s||"user"===e.publisher.type&&e.publisher.id===t.current_user.id&&this.list.unshift(e))},onRepost(e){}}},r={template:"#vxfeed__status",emits:["update","delete","quote","repost"],components:{"quoted-status":{template:"#vxfeed__quoted-status",props:{quoteOf:Object},computed:{highlightedContent(){return this.$root.highlightContent(this.quoteOf.content)},truncatedContent(){return this.$root.truncate(this.highlightedContent,this.$root.config.settings.quotes.truncate_at)},titleDetails(){var e=[];return this.quoteOf.publisher.username&&e.push("@"+this.quoteOf.publisher.username),this.quoteOf.post&&e.push(this.quoteOf.post.title),e.push(this.quoteOf.created_at),e.join(" · ")},review(){const t=this.quoteOf.review;var e;return t?((e={config:this.$root.config.reviews[t.post_type]}).level=e.config.rating_levels.find(e=>t.score>=e.score-.5&&t.score<e.score+.5),e):null}}}},props:{status:Object,repostedBy:{type:Object,default:null},feedRef:{type:Object,default:null}},data(){return{screen:null,showActions:!1,showRepost:!1,showQuoteBox:!1,showComments:!1,readMore:!1,linkPreview:{image:this.$root.config.settings.link_preview.default_image},commentFeed:{ready:!1},showActiveComment:this.feedRef?.isSingle&&null!==this.$root.config.single_reply_id,state:{liking:!1,reposting:!1,deleting:!1}}},created(){const t=this.$root.config.current_user;document.addEventListener(`voxel/tl/status/${this.status.id}/like`,e=>{"unlike"===e.detail.action?(--this.status.likes.count,this.status.current_user.has_liked=!1,this.status.likes.last3=this.status.likes.last3.filter(e=>!("user"===e.type&&e.id===t.id))):(this.status.likes.count+=1,this.status.current_user.has_liked=!0,this.status.likes.last3.unshift({id:t.id,type:"user",display_name:t.display_name,link:t.link,avatar_url:t.avatar_url}),this.status.likes.last3=this.status.likes.last3.slice(0,3))}),document.addEventListener(`voxel/tl/status/${this.status.id}/repost`,e=>{this.status.current_user.has_reposted="repost"===e.detail.action}),this.feedRef?.isSingle&&(this.showComments=!0)},mounted(){this.$nextTick(()=>{new IntersectionObserver((e,t)=>{e.forEach(e=>{e.isIntersecting&&(this.onFirstViewportEnter(),t.disconnect())})},{root:null,threshold:0}).observe(this.$refs.wrapper)})},methods:{onFirstViewportEnter(){var e;this.status.link_preview?.image&&((e=new Image).src=this.status.link_preview.image,e.onload=()=>this.linkPreview.image=this.status.link_preview.image)},onUpdate(e){this.screen=null,this.$emit("update",e)},deleteStatus(){const e=()=>{this.state.deleting=!0,jQuery.post(Voxel_Config.ajax_url+"&action=timeline/v2/status.delete",{status_id:this.status.id,_wpnonce:this.$root.config.nonce}).always(e=>{this.state.deleting=!1,e.success?(Voxel.alert(e.message,"success",null,3e3),this.$emit("delete"),this.screen="deleted"):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})};Voxel.prompt(Voxel_Config.l10n.confirmAction,"warning",[{label:Voxel_Config.l10n.yes,onClick:()=>e()},{label:Voxel_Config.l10n.no,onClick:()=>{}}],7500)},likeStatus(){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();const t=this.status.current_user.has_liked?"unlike":"like";document.dispatchEvent(new CustomEvent(`voxel/tl/status/${this.status.id}/like`,{detail:{action:t}})),this.state.liking=!0,jQuery.post(Voxel_Config.ajax_url+"&action=timeline/v2/status.like",{status_id:this.status.id,_wpnonce:this.$root.config.nonce}).always(e=>{this.state.liking=!1,e.success||(document.dispatchEvent(new CustomEvent(`voxel/tl/status/${this.status.id}/like`,{detail:{action:"unlike"==t?"like":"unlike"}})),Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})},repostStatus(){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();const t=this.status.current_user.has_reposted?"unrepost":"repost";document.dispatchEvent(new CustomEvent(`voxel/tl/status/${this.status.id}/repost`,{detail:{action:t}})),this.state.reposting=!0,jQuery.post(Voxel_Config.ajax_url+"&action=timeline/v2/status.repost",{status_id:this.status.id,_wpnonce:this.$root.config.nonce}).always(e=>{this.state.reposting=!1,e.success?("repost"===e.action&&this.$emit("repost",e.status),Voxel.alert(e.message,"success",null,3e3)):(document.dispatchEvent(new CustomEvent(`voxel/tl/status/${this.status.id}/repost`,{detail:{action:"unrepost"==t?"repost":"unrepost"}})),Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})},quoteStatus(){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();this.showQuoteBox=!0},onQuotePublish(e){this.$refs.quoter.reset(),this.showQuoteBox=!1,this.$emit("quote",e)},writeReply(){if(this.showComments)this.showComments=!1;else{if(this.showComments=!0,!Voxel_Config.is_logged_in)return Voxel.authRequired();const e=()=>{this.$nextTick(()=>{this.$refs.commentFeed.$refs.composer.focus()})};if(this.commentFeed.ready)e();else{const t=this.$watch("commentFeed.ready",()=>{e(),t()})}}},copyLink(){Voxel.copy(this.status.link),this.showActions=!1},share(){Voxel.share({url:this.status.link}),this.showActions=!1},removeLinkPreview(){this.status.link_preview=null,this.showActions=!1,jQuery.post(Voxel_Config.ajax_url+"&action=timeline/v2/status.remove_link_preview",{status_id:this.status.id,_wpnonce:this.$root.config.nonce})},markApproved(){this.showActions=!1,jQuery.post(Voxel_Config.ajax_url+"&action=timeline/v2/status.mark_approved",{status_id:this.status.id,_wpnonce:this.$root.config.nonce}).always(e=>{e.success?(this.status.is_pending=!1,this.status.badges=e.badges):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},markPending(){this.showActions=!1,jQuery.post(Voxel_Config.ajax_url+"&action=timeline/v2/status.mark_pending",{status_id:this.status.id,_wpnonce:this.$root.config.nonce}).always(e=>{e.success?(this.status.is_pending=!0,this.status.badges=e.badges):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}},computed:{highlightedContent(){return this.$root.highlightContent(this.status.content,{linkPreview:this.status.link_preview})},truncatedContent(){return this.$root.truncate(this.highlightedContent,this.$root.config.settings.posts.truncate_at)},review(){const i=this.status.review;if(!i)return null;const o={config:this.$root.config.reviews[i.post_type]},r=t=>o.config.rating_levels.find(e=>t>=e.score-.5&&t<e.score+.5);return o.level=r(i.score),o.categories=[],Object.keys(i.rating).forEach(t=>{var e=i.rating[t],s=o.config.categories.find(e=>e.key===t);"number"==typeof e&&s&&o.categories.push({key:s.key,label:s.label,score:e,level:r(e)})}),o},showPostLink(){return!!(this.status.post&&["post_wall","post_reviews"].includes(this.status.feed)&&["user_feed","global_feed","author_timeline","single_status"].includes(this.$root.config.timeline.mode))}}},n={template:"#vx-file-upload",props:{field:Object,sortable:{type:Boolean,default:!0},allowedFileTypes:String,maxFileCount:{type:Number,default:1},modelValue:Array,context:Object},emits:["update:modelValue"],data(){return{dragActive:!1,reordering:!1,value:this.modelValue,id:"file-upload-"+Voxel.helpers.sequentialId()}},mounted(){jQuery(this.$refs.input).on("change",e=>{for(var t=0;t<e.target.files.length;t++){var s=e.target.files[t];this.pushFile(s)}this.$refs.input.value="",this.update()})},unmounted(){setTimeout(()=>{Array.isArray(this.value)&&this.value.forEach(e=>{"new_upload"===e.source&&URL.revokeObjectURL(e.preview)})},10)},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},pushFile(t){1===this.maxFileCount&&(this.value=[]);var e={source:"new_upload",name:t.name,type:t.type,size:t.size,preview:URL.createObjectURL(t),item:t,_id:Voxel.helpers.randomId(8)},s=(void 0===window._vx_file_upload_cache&&(window._vx_file_upload_cache=[]),window._vx_file_upload_cache.find(e=>e.item.name===t.name&&e.item.type===t.type&&e.item.size===t.size&&e.item.lastModified===t.lastModified));s?this.value.push(s):(this.value.push(e),window._vx_file_upload_cache.unshift(e))},onDrop(e){this.dragActive=!1,e.dataTransfer.items?[...e.dataTransfer.items].forEach(e=>{"file"===e.kind&&this.pushFile(e.getAsFile())}):[...e.dataTransfer.files].forEach(e=>{this.pushFile(e)}),this.update()},onMediaPopupSave(e){1===this.maxFileCount&&(this.value=[]);var t={};this.value.forEach(e=>{"existing"===e.source&&(t[e.id]=!0),"new_upload"===e.source&&(t[e._id]=!0)}),Object.values(e).forEach(e=>{"existing"!==e.source||t[e.id]||this.value.push(e),"new_upload"!==e.source||t[e._id]||this.value.push(e)}),this.update()},update(){this.$emit("update:modelValue",this.value)}},watch:{modelValue(e){this.value=e}}},a={template:"#create-post-media-popup",props:{multiple:{type:Boolean,default:!0},ignore:{type:Array,default:[]},customTarget:[Object,String],saveLabel:String},emits:["save","blur","open"],data(){return{files:[],selected:{},active:!1,loading:!0,has_more:!1,firstLoad:!0,search:{term:"",offset:0,loading:!1,loading_more:!1,has_more:!1,list:null}}},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},selectFile(e){this.selected[e.id]?delete this.selected[e.id]:(this.multiple||(this.selected={}),this.selected[e.id]=e)},selectSessionFile(e){this.selected[e._id]?delete this.selected[e._id]:(this.multiple||(this.selected={}),this.selected[e._id]=e)},loadMedia(){jQuery.get(Voxel_Config.ajax_url+"&action=list_media",{offset:this.files.length}).always(e=>{this.loading=!1,e.success?(this.files.push(...e.data),this.has_more=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},loadMore(){this.loading=!0,this.loadMedia()},openLibrary(){this.$emit("open"),this.firstLoad&&this.loadMedia(),this.firstLoad=!1,this.active=!this.active},isImage(e){return e.type.startsWith("image/")},save(){this.active=!1,this.$emit("save",this.selected),this.selected={}},clear(){this.selected={}},clientSearchFiles(){let t=this.search.term.trim().toLowerCase(),s=[],i=!1;this.files.forEach(e=>{i||-1!==e.name.toLowerCase().indexOf(t)&&(s.push(e),i=10<=s.length)}),this.search.list=s,this.search.loading=!1,this.search.has_more=!1,this.search.loading_more=!1},serverSearchFiles:Voxel.helpers.debounce((t,s=!1)=>{jQuery.get(Voxel_Config.ajax_url+"&action=list_media",{offset:s?t.search.list.length:0,search:t.search.term.trim()}).always(e=>{t.search.loading=!1,t.search.loading_more=!1,e.success?(s?t.search.list.push(...e.data):t.search.list=e.data,t.search.has_more=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}),sessionFiles(){return Array.isArray(window._vx_file_upload_cache)||(window._vx_file_upload_cache=[]),window._vx_file_upload_cache.reverse()}},watch:{"search.term"(){this.search.term.trim()&&this.files&&(this.search.loading=!0,!this.has_more||this.search.term.trim().length<=2?this.clientSearchFiles():this.serverSearchFiles(this))}}};window.render_timeline_v2=()=>{Array.from(document.querySelectorAll(".vxfeed")).forEach(e=>{if(!e.__vue_app__&&!e.classList.contains("no-render")){try{var t=JSON.parse(e.closest(".elementor-element").querySelector(".vxconfig").innerHTML),s=JSON.parse(e.closest(".elementor-element").querySelector(".vxconfig__icons").innerHTML)}catch(e){return void console.log(e.message)}"object"!=typeof window._vx_feed_cache&&(window._vx_feed_cache={}),"object"!=typeof window._vx_mentions_cache&&(window._vx_mentions_cache={});const i=((e,n)=>{const t=document.createElement("textarea");return Vue.createApp({el:e,mixins:[Voxel.mixins.base],data(){return{commentFeeds:{}}},created(){this.RG_CODE_BLOCK=/^```([A-Za-z0-9._-]{0,24})\r?\n([\s\S]*?)\r?\n```$/gm,this.RG_INLINE_CODE=/(^|\s)`(\S(?:.*?\S)?)`/g,this.RG_USERNAME=/(^|\s)(@[A-Za-z0-9._·@-]{1,63})/g,this.RG_HASHTAG=/(^|\s)(#[\p{L}\p{N}\p{M}\p{S}_\.]{1,63})/gu,this.RG_REGULAR_LINK=/\bhttps?:\/\/\S+/gi,this.RG_TEXT_BOLD=/(^|\s)\*(\S(?:.*?\S)?)\*/g,this.RG_TEXT_ITALIC=/(^|\s)\_(\S(?:.*?\S)?)\_/g,this.RG_TEXT_STRIKETHROUGH=/(^|\s)\~(\S(?:.*?\S)?)\~/g,this.config=n,this.l10n=n.l10n},methods:{escapeHTML(e){return t.textContent=e,t.innerHTML},truncate(e,t=256){var s=document.createElement("div");s.innerHTML=e;let i=t,o=!1,r=0,n=e=>{var t;o?e.remove():(t=Array.from(e.childNodes)).length?t.forEach(e=>n(e)):(r+=e.textContent.length)>=i&&(o=!0,r>i&&(e.textContent=e.textContent.slice(0,-(r-i))),e.textContent+="…")};return n(s),{content:s.innerHTML,exists:o}},highlightContent(e,t={}){let s=this.escapeHTML(e),i=[];const r=e=>{var t=` {${Voxel.helpers.randomId(32)}} `;return i.push({id:t,content:e}),t};return s=(s=(s=(s=s.replace(this.RG_CODE_BLOCK,(e,t,s)=>{t=t.length?`data-lang="${t}"`:"";return r(`<pre class="min-scroll" ${t}>${s}</pre>`)})).replace(this.RG_INLINE_CODE,(e,t,s)=>r(t+`<code>${s}</code>`))).replace(this.RG_USERNAME,(e,t,s)=>{var i=s.replaceAll("·",'<span style="opacity:.3;">·</span>'),o=new URL(n.settings.mentions.url);return o.searchParams.set("username",s.substr(1)),r(`${t}<a href="${o.toString()}">${i}</a>`)})).replace(this.RG_HASHTAG,(e,t,s)=>{var i=new URL(n.settings.hashtags.url);return i.searchParams.set("q",s),r(`${t}<a href="${i.toString()}">${s}</a>`)}),s=(s=(s=(s=(s=t.linkPreview&&t.linkPreview.url?.length&&s.endsWith(t.linkPreview.url)?s.slice(0,-t.linkPreview.url.length).trimEnd():s).replace(this.RG_REGULAR_LINK,t=>{try{return`<a href="${new URL(t).toString()}" rel="noopener noreferrer" target="_blank">${t}</a>`}catch(e){return t}})).replace(this.RG_TEXT_BOLD,(e,t,s)=>t+`<strong>${s}</strong>`)).replace(this.RG_TEXT_ITALIC,(e,t,s)=>t+`<em>${s}</em>`)).replace(this.RG_TEXT_STRIKETHROUGH,(e,t,s)=>t+`<del>${s}</del>`),i.forEach(e=>{s=s.replace(e.id,e.content)}),s}}})})(e,t);i.component("status-feed",o),i.component("status-single",r),i.component("status-composer",Vue.defineAsyncComponent(()=>import(t.async.composer))),i.component("comment-feed",Vue.defineAsyncComponent(()=>import(t.async.comments).then(e=>(i.component("comment-composer",e.default.Comment_Composer),i.component("comment-single",e.default.Comment_Single),e.default.Comment_Feed)))),n.template="#vxfeed__file-upload",i.component("file-upload",n),i.component("media-popup",a),i.component("form-popup",Voxel.components.popup),i.component("form-group",Voxel.components.formGroup),i.component("transition-height",{template:'<transition name="ts-expand" @after-enter="afterEnter" @enter="enter" @leave="leave"><slot></slot></transition>',methods:{afterEnter(e){e.style.height="auto"},enter(e){const t=getComputedStyle(e)["height"];e.style.height=0,requestAnimationFrame(()=>e.style.height=t)},leave(e){e.style.height=getComputedStyle(e).height,requestAnimationFrame(()=>e.style.height=0)}}}),i.component("dropdown-list",{props:["target"],emits:["blur"],template:"#vxfeed__dd-list"}),Object.keys(s).forEach(e=>{i.component("icon-"+e,{template:s[e]||"\x3c!-- icon --\x3e"})}),i.mount(e)}})},window.render_timeline_v2(),jQuery(document).on("voxel:markup-update",window.render_timeline_v2)});
