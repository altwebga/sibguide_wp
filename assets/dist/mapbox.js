!function(t){"function"==typeof define&&define.amd?define("mapbox",t):t()}(function(){"use strict";function t(t,e){return t(e={exports:{}},e.exports),e.exports}Voxel.Maps.Autocomplete=function(t,e,o={}){this.init(t,e,o)},Voxel.Maps.Autocomplete.prototype.selectFirstResult=function(t){},Voxel.Maps.Bounds=function(t,e){this.southwest=t,this.northeast=e,this.init(t,e)},Voxel.Maps.Bounds.prototype.extend=function(t){},Voxel.Maps.Bounds.prototype.empty=function(){},Voxel.Maps.Bounds.prototype.getSourceObject=function(){},Voxel.Maps.Bounds.prototype.getSouthWest=function(){return this.southwest},Voxel.Maps.Bounds.prototype.getNorthEast=function(){return this.northeast},Voxel.Maps.Geocoder=function(){this.init()},Voxel.Maps.getGeocoder=function(){return Voxel.Maps._geocoder||(Voxel.Maps._geocoder=new Voxel.Maps.Geocoder),Voxel.Maps._geocoder},Voxel.Maps.Geocoder.prototype.geocode=function(t,e,o){},Voxel.Maps.Geocoder.prototype.formatFeature=function(t){},Voxel.Maps.Geocoder.prototype.getUserLocation=function({fetchAddress:e=!0,receivedPosition:o=t=>{},receivedAddress:s=t=>{},positionFail:t=()=>{},addressFail:n=()=>{}}={}){if(!navigator.geolocation)return t();navigator.geolocation.getCurrentPosition(t=>{t=new Voxel.Maps.LatLng(t.coords.latitude,t.coords.longitude);o(t),!1!==e&&Voxel.Maps.getGeocoder().geocode(t.toGeocoderFormat(),t=>t?s(t):(Voxel.alert(Voxel_Config.l10n.positionFail,"error"),n()))},()=>t())},Voxel.Maps.LatLng=function(t,e){this.init(t,e)},Voxel.Maps.LatLng.prototype.getLatitude=function(){},Voxel.Maps.LatLng.prototype.getLongitude=function(){},Voxel.Maps.LatLng.prototype.getSourceObject=function(){},Voxel.Maps.LatLng.prototype.toGeocoderFormat=function(){},Voxel.Maps.Map=function({el:t,zoom:e=10,center:o=new Voxel.Maps.LatLng(Voxel_Config.maps.default_lat,Voxel_Config.maps.default_lng),minZoom:s=4,maxZoom:n=20,draggable:i=!0}){this.init({el:t,zoom:e,center:o,minZoom:s,maxZoom:n,draggable:i})},Voxel.Maps.Map.prototype.setZoom=function(t){},Voxel.Maps.Map.prototype.getZoom=function(){},Voxel.Maps.Map.prototype.getMinZoom=function(){},Voxel.Maps.Map.prototype.getMaxZoom=function(){},Voxel.Maps.Map.prototype.setCenter=function(t){},Voxel.Maps.Map.prototype.getCenter=function(){},Voxel.Maps.Map.prototype.fitBounds=function(t){},Voxel.Maps.Map.prototype.panTo=function(t){},Voxel.Maps.Map.prototype.getClickPosition=function(t){},Voxel.Maps.Map.prototype.addListener=function(t,e){},Voxel.Maps.Map.prototype.addListenerOnce=function(t,e){},Voxel.Maps.Map.prototype.removeListener=function(t){},Voxel.Maps.Map.prototype.trigger=function(t){},Voxel.Maps.Map.prototype.mapEvent=function(t){return void 0!==this.eventMap[t]?this.eventMap[t]:t},Voxel.Maps.Map.prototype.removeMarkers=function(){for(var t=0;t<this.markers.length;t++)this.markers[t].remove();this.markers=[]},Voxel.Maps.Map.prototype.getSourceObject=function(){},Voxel.Maps.Marker=function({map:t=null,position:e=null,onClick:o=null,template:s=null,data:n=null}){this.template=s,this.init({map:t,position:e,onClick:o,data:n})},Voxel.Maps.Marker.prototype.getPosition=function(){},Voxel.Maps.Marker.prototype.setPosition=function(t){},Voxel.Maps.Marker.prototype.getMap=function(){},Voxel.Maps.Marker.prototype.setMap=function(t){},Voxel.Maps.Marker.prototype.remove=function(){},Voxel.Maps.Marker.prototype.addClass=function(){},Voxel.Maps.Marker.prototype.removeClass=function(){},Voxel.Maps.Marker.prototype.getTemplate=function(){var t=this.template||'<div class="map-marker marker-type-icon"><i class="las la-map-marker"></i></div>';return jQuery(`<div class="marker-wrapper">${t}</div>`)},Voxel.Maps.Popup=function({map:t=null,position:e=null,content:o=null}){this.init({map:t,position:e,content:o})},Voxel.Maps.Popup.prototype.init=function(t){},Voxel.Maps.Popup.prototype.setContent=function(t){},Voxel.Maps.Popup.prototype.setPosition=function(t){},Voxel.Maps.Popup.prototype.setMap=function(t){},Voxel.Maps.Popup.prototype.show=function(){},Voxel.Maps.Popup.prototype.hide=function(){},Voxel.Maps.Circle=function({map:t=null,center:e=null,radius:o=null,visible:s=null,className:n="map-circle"}){this.init({map:t,center:e,radius:o,visible:s,className:n})},Voxel.Maps.Clusterer=function({map:t=null}){this.init({map:t})};var i=t(function(t){function e(t){if(t=Object.assign({},t),!(this instanceof e))throw new Error("MapboxLanguage needs to be called with the new keyword");this.setLanguage=this.setLanguage.bind(this),this._defaultLanguage=t.defaultLanguage,this._isLanguageField=t.languageField||/^name_/,this._getLanguageField=t.getLanguageField||function(t){return"mul"===t?"name":"name_"+t},this._languageSource=t.languageSource||null,this._languageTransform=t.languageTransform,this._excludedLayerIds=t.excludedLayerIds||[],this.supportedLanguages=t.supportedLanguages||["de","en","fr","it","nl","az","bn","ca","cs","da","el","fa","fi","ga","hu","id","is","ja","ka","km","ko","lo","lv","mn","pt","ro","sq","th","tl","vi","zh","zh_Hans","zh_TW","ar","bs","es","gu","he","hi","kk","lt","my","nb","pl","sk","sr","sv","te","tk","tr","zh_Hant","uk","ru"]}const s=/^\{name/;function i(t,e){var o=Array.isArray(e)&&"get"===e[0];return o&&s.test(e[1])&&console.warn("This plugin no longer supports the use of token syntax (e.g. {name}). Please use a get expression. See https://docs.mapbox.com/mapbox-gl-js/style-spec/expressions/ for more details."),o&&t.test(e[1])}function u(t,e,o){return i(t,e)&&(e[1]=o),function e(o,s,n){if(Array.isArray(s))for(let t=1;t<s.length;t++)Array.isArray(s[t])&&(i(o,s[t])&&(s[t][1]=n),e(o,s[t],n))}(t,e,o),e="get"===e[0]&&"name"===e[1]?["coalesce",["get",o],e.slice()]:e}e.prototype.setLanguage=function(t,e){if(this.supportedLanguages.indexOf(e)<0)throw new Error(`Language ${e} is not supported`);const i=this._languageSource||function(e){var t=Object.keys(e.sources).filter(t=>{t=e.sources[t].url;return t&&-1<t.indexOf("mapbox.mapbox-streets-v8")||/mapbox-streets-v[1-9][1-9]/.test(t)});if(t.length)return t[0];throw new Error('If using MapboxLanguage with a Mapbox style, the style must be based on vector tile version 8, e.g. "streets-v11"')}(t);if(!i)return t;const r=this._getLanguageField(e),a=this._isLanguageField,p=this._excludedLayerIds;var o=t.layers.map(t=>{var e,o,s,n;return t.source===i?(e=a,o=t,s=r,n=p,o.layout&&o.layout["text-field"]&&-1===n.indexOf(o.id)?Object.assign({},o,{layout:Object.assign({},o.layout,{"text-field":u(e,o.layout["text-field"],s)})}):o):t}),t=Object.assign({},t,{layers:o});return this._languageTransform?this._languageTransform(t,e):t},t.exports=e}),e=(Voxel.Maps.Autocomplete.prototype.init=function(t,e,o){!t instanceof Element||(this.el=t,this.onChange=e,this.input=jQuery(this.el),this.focusedItem=0,this.hasQueried=!1,this.options=o,this.attachDropdown(),this.input.on("input",Voxel.helpers.debounce(this.querySuggestions.bind(this),200)),this.input.on("focusin",this.showDropdown.bind(this)),this.input.on("focusout",this.hideDropdown.bind(this)),this.input.on("keydown click",this.navigateDropdown.bind(this)),this.dropdown.on("click",".suggestion",t=>this.selectItem(jQuery(t.currentTarget).index())))},Voxel.Maps.Autocomplete.prototype.querySuggestions=function(t){this.resetFocus(),this.showDropdown(),this.onChange(),Voxel.Maps.getGeocoder().geocode(t.target.value,{limit:5,_ac:this.options},function(t){if(this.hasQueried=!0,this.removeSuggestions(),!t)return!1;t.forEach(this.addSuggestion.bind(this))}.bind(this))},Voxel.Maps.Autocomplete.prototype.navigateDropdown=function(t){this.hasQueried||this.input.trigger("input"),this.showDropdown(),40===t.keyCode&&(this.focusedItem++,this.focusItem()),38===t.keyCode&&(this.focusedItem--,this.focusItem()),13===t.keyCode&&(t.preventDefault(),0!==this.focusedItem)&&this.selectItem(this.focusedItem-1)},Voxel.Maps.Autocomplete.prototype.focusItem=function(){this.dropdown.find(".suggestions-list .suggestion").removeClass("active");var t=this.dropdown.find(".suggestions-list .suggestion");this.focusedItem<0&&(this.focusedItem=t.length),this.focusedItem>t.length&&(this.focusedItem=0),0!==this.focusedItem&&this.dropdown.find(".suggestions-list .suggestion").eq(this.focusedItem-1).addClass("active")},Voxel.Maps.Autocomplete.prototype.resetFocus=function(t){this.focusedItem=0,this.dropdown.find(".suggestions-list .suggestion").removeClass("active")},Voxel.Maps.Autocomplete.prototype.showDropdown=function(t){var e,o;this.el?.value&&(this.dropdown.addClass("active"),e=this.input.get(0).getBoundingClientRect(),o=this.input.offset(),this.dropdown.css({top:o.top+e.height+"px",left:o.left+"px",width:e.width+"px"}))},Voxel.Maps.Autocomplete.prototype.hideDropdown=function(t){this.dropdown.removeClass("active")},Voxel.Maps.Autocomplete.prototype.selectItem=function(t){t=this.dropdown.find(".suggestions-list .suggestion").eq(t).data("place");this.input.val(t.address),this.resetFocus(),this.hideDropdown(),this.onChange(t)},Voxel.Maps.Autocomplete.prototype.selectFirstResult=function(t){0===this.focusedItem&&this.dropdown.find(".suggestions-list .suggestion").eq(0).length&&(this.selectItem(0),t())},Voxel.Maps.Autocomplete.prototype.attachDropdown=function(){this.dropdown=jQuery('<div class="ts-autocomplete-dropdown"><div class="suggestions-list"></div></div>'),this.input.addClass("ts-autocomplete-input").attr("autocomplete","off"),jQuery("body").append(this.dropdown)},Voxel.Maps.Autocomplete.prototype.removeSuggestions=function(){this.dropdown.find(".suggestions-list").html("")},Voxel.Maps.Autocomplete.prototype.addSuggestion=function(t){var e=jQuery(['<div class="suggestion">','<span class="suggestion--address"></span>',"</div>"].join(""));e.data("place",t),e.find(".suggestion--address").text(t.address),this.dropdown.find(".suggestions-list").append(e)},Voxel.Maps.Bounds.prototype.init=function(t,e){this.southwest=t,this.northeast=e,this.bounds=new mapboxgl.LngLatBounds(t?.getSourceObject(),e?.getSourceObject())},Voxel.Maps.Bounds.prototype.getSouthWest=function(){return this.southwest},Voxel.Maps.Bounds.prototype.getNorthEast=function(){return this.northeast},Voxel.Maps.Bounds.prototype.extend=function(t){this.bounds.extend(t.getSourceObject())},Voxel.Maps.Bounds.prototype.empty=function(){return this.bounds.isEmpty()},Voxel.Maps.Bounds.prototype.getSourceObject=function(){return this.bounds},Voxel.Maps.Geocoder.prototype.init=function(){},Voxel.Maps.Geocoder.prototype.geocode=function(t,o,e){var s=this,n=!1,i=("function"==typeof o&&(e=o,o={}),{access_token:Voxel_Config.mapbox?.api_key,limit:1,language:Voxel_Config.mapbox.language}),r=o._ac,o=(delete o._ac,r?.feature_types?.length&&(o.types=r.feature_types.join(",")),r?.countries?.length&&(o.country=r.countries.join(",")),jQuery.extend(!0,{},i,o));if(!encodeURIComponent(t).length)return e(n);jQuery.get({url:"https://api.mapbox.com/geocoding/v5/mapbox.places/{query}.json".replace("{query}",encodeURIComponent(t)),data:o,dataType:"json",success:function(t,e){"success"===e&&t&&t.features.length&&(n=1===o.limit?s.formatFeature(t.features[0]):t.features.map(s.formatFeature))},complete:function(){e(n)}})},Voxel.Maps.Geocoder.prototype.formatFeature=function(t){var e;return e=t.bbox?new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t.bbox[1],t.bbox[0]),new Voxel.Maps.LatLng(t.bbox[3],t.bbox[2])):(e=1/370,new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t.geometry.coordinates[1]-e,t.geometry.coordinates[0]-e),new Voxel.Maps.LatLng(t.geometry.coordinates[1]+e,t.geometry.coordinates[0]+e))),{address:t.place_name,latlng:new Voxel.Maps.LatLng(t.geometry.coordinates[1],t.geometry.coordinates[0]),viewport:e}},Voxel.Maps.LatLng.prototype.init=function(t,e){this.latlng=new mapboxgl.LngLat(e,t)},Voxel.Maps.LatLng.prototype.getLatitude=function(){return this.latlng.lat},Voxel.Maps.LatLng.prototype.getLongitude=function(){return this.latlng.lng},Voxel.Maps.LatLng.prototype.toGeocoderFormat=function(){return[this.getLongitude(),this.getLatitude()].join(",")},Voxel.Maps.LatLng.prototype.getSourceObject=function(){return this.latlng},Voxel.Maps.Map.prototype.init=function({el:t,zoom:e,center:o,minZoom:s,maxZoom:n}){this.eventMap={zoom_changed:"zoomstart",bounds_changed:"moveend"},this.map=new mapboxgl.Map({container:t,zoom:e,minZoom:1.5<=s?s:1.5,maxZoom:n<=24?n:24,interactive:!0,style:Voxel_Config.mapbox?.skin||"mapbox://styles/mapbox/streets-v12",scrollZoom:!0,projection:"mercator",dragRotate:!1}),this.map.addControl(new mapboxgl.NavigationControl({showCompass:!1})),this.map.addControl(new mapboxgl.FullscreenControl),this.addListenerOnce("style.load",()=>Voxel.Maps.MapboxSetLanguage(this)),this.addListenerOnce("idle",()=>{t?.querySelector?.(".mapbox-improve-map")?.remove?.()}),this.setCenter(o),t.__vx_map__=this},Voxel.Maps.Map.prototype.setZoom=function(t){this.map.setZoom(t)},Voxel.Maps.Map.prototype.getZoom=function(){return this.map.getZoom()},Voxel.Maps.Map.prototype.getMinZoom=function(){return this.map.getMinZoom()},Voxel.Maps.Map.prototype.getMaxZoom=function(){return this.map.getMaxZoom()},Voxel.Maps.Map.prototype.setCenter=function(t){this.map.setCenter(t.getSourceObject())},Voxel.Maps.Map.prototype.getCenter=function(){return new Voxel.Maps.LatLng(this.map.getCenter().lat,this.map.getCenter().lng)},Voxel.Maps.Map.prototype.getBounds=function(){var t=this.map.getBounds(),e=t.getNorthEast(),t=t.getSouthWest();return new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t.lat,t.lng),new Voxel.Maps.LatLng(e.lat,e.lng))},Voxel.Maps.Map.prototype.fitBounds=function(t){t.getSourceObject().isEmpty()||this.map.fitBounds(t.getSourceObject(),{padding:15,animate:!1})},Voxel.Maps.Map.prototype.panTo=function(t){this.map.panTo(t.getSourceObject())},Voxel.Maps.Map.prototype.getClickPosition=function(t){return new Voxel.Maps.LatLng(t.lngLat.lat,t.lngLat.lng)},Voxel.Maps.Map.prototype.addListener=function(t,e){return this.map.on(this.mapEvent(t),function(t){e(t)}),{event:t,cb:e}},Voxel.Maps.Map.prototype.addListenerOnce=function(t,e){return this.map.once(this.mapEvent(t),function(t){e(t)}),{event:t,cb:e}},Voxel.Maps.Map.prototype.removeListener=function(t){this.map.off(t.event,t.cb)},Voxel.Maps.Map.prototype.trigger=function(t){this.map.fire(this.mapEvent(t))},Voxel.Maps.Map.prototype.getSourceObject=function(){return this.map},Voxel.Maps.Marker.prototype.init=function({map:t,position:e,onClick:o,data:s}){this.data=s,this.node=this.getTemplate().get(0),this.marker=new mapboxgl.Marker(this.node),this.onClick=o,this.node.addEventListener("click",t=>{o&&o(t,this)}),e&&this.setPosition(e),t&&this.setMap(t)},Voxel.Maps.Marker.prototype.getPosition=function(){return this.position},Voxel.Maps.Marker.prototype.setPosition=function(t){this.position=t,this.marker.setLngLat(t.getSourceObject())},Voxel.Maps.Marker.prototype.getMap=function(){return this.map},Voxel.Maps.Marker.prototype.setMap=function(t){this.map=t,this.marker.addTo(t.getSourceObject())},Voxel.Maps.Marker.prototype.remove=function(){return this.marker.remove(),this},Voxel.Maps.Marker.prototype.addClass=function(t){return this.node?.classList.add(t)},Voxel.Maps.Marker.prototype.removeClass=function(t){return this.node?.classList.remove(t)},Voxel.Maps.Marker.prototype.getSourceObject=function(){return this.marker},Voxel.Maps.Popup.prototype.init=function({map:t,position:e,content:o}){this.popup=new mapboxgl.Popup({closeButton:!1,maxWidth:"none",className:"ts-mapbox-popup ts-marker",anchor:"bottom",offset:0}),this.map=t,e&&this.setPosition(e),o&&this.setContent(o),t&&this.setMap(t)},Voxel.Maps.Popup.prototype.setContent=function(t){this.popup.setDOMContent(t)},Voxel.Maps.Popup.prototype.setPosition=function(t){this.popup.setLngLat(t.getSourceObject())},Voxel.Maps.Popup.prototype.setMap=function(t){this.map=t},Voxel.Maps.Popup.prototype.remove=function(){this.popup.remove()},Voxel.Maps.Popup.prototype.show=function(){this.popup.addTo(this.map.getSourceObject()),setTimeout(()=>this.fitToScreen(),10)},Voxel.Maps.Popup.prototype.hide=function(){this.popup.remove()},Voxel.Maps.Popup.prototype.fitToScreen=function(){var t=this.popup.getElement(),e=t.getBoundingClientRect();let o=e.height+10,s=e.width/2+10,n=30,i=e.width/2+10;var e=this.map.getSourceObject(),r=e.getCanvas().getBoundingClientRect(),a=e.project(e.getCenter());let p=a.x,u=a.y;var c=e.project(this.popup.getLngLat());r.width-c.x<s&&(a.x+=s-(r.width-c.x)),c.x<i&&(a.x-=i-c.x),c.y<o-1&&(a.y-=o-c.y),r.height-c.y<n-1&&(a.y+=n-(r.height-c.y)),a.x===p&&a.y===u||e.panTo(e.unproject(a),{duration:t.querySelector(".ts-loading-popup")?0:200})},Voxel.Maps.Circle.prototype.init=function({map:t=null,center:e=null,radius:o=null}){this.map=t,this.locationNode=jQuery('<div class="hidden"><div class="map-circle-center"></div></div>').get(0),this.locationMarker=new mapboxgl.Marker(this.locationNode),this.locationMarker.setLngLat(e.getSourceObject()),this.locationMarker.addTo(t.getSourceObject()),this.node=jQuery('<div class="hidden"><div class="map-circle"></div></div>').get(0),this.marker=new mapboxgl.Marker(this.node),this.marker.setLngLat(e.getSourceObject()),this.radius=o,this.marker.addTo(t.getSourceObject()),this._draw(),t.addListener("zoom",()=>this._draw()),t.addListener("pitch",()=>this._draw())},Voxel.Maps.Circle.prototype.hide=function(){this.node.classList.add("hidden"),this.locationNode.classList.add("hidden")},Voxel.Maps.Circle.prototype.show=function(){this.node.classList.remove("hidden"),this.locationNode.classList.remove("hidden")},Voxel.Maps.Circle.prototype.setCenter=function(t){this.marker.setLngLat(t.getSourceObject()),this.locationMarker.setLngLat(t.getSourceObject()),this._draw()},Voxel.Maps.Circle.prototype.setRadius=function(t){this.radius=t,this._draw()},Voxel.Maps.Circle.prototype.getBounds=function(){return new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(this.bounds.getSouth(),this.bounds.getWest()),new Voxel.Maps.LatLng(this.bounds.getNorth(),this.bounds.getEast()))},Voxel.Maps.Circle.prototype._updateBounds=function(){var t=this.marker.getLngLat(),e={north:null,east:null,south:null,west:null},o=(e.east=e.west=this.radius/t.distanceTo(new mapboxgl.LngLat(t.lng+1,t.lat)),e.north=this.radius/t.distanceTo(new mapboxgl.LngLat(t.lng,t.lat+1)),e.south=this.radius/t.distanceTo(new mapboxgl.LngLat(t.lng,t.lat-1)),(t,e,o)=>Math.max(e,Math.min(t,o)));this.bounds=new mapboxgl.LngLatBounds([o(t.lng-e.west,-180,180),o(t.lat-e.south,-90,90)],[o(t.lng+e.east,-180,180),o(t.lat+e.north,-90,90)])},Voxel.Maps.Circle.prototype._draw=function(){this._updateBounds();var t=this.map.getSourceObject(),e=t.project(this.bounds.getSouthWest()),t=t.project(this.bounds.getNorthEast()),o=this.node.querySelector(".map-circle");o.style.left=e.x+"px",o.style.top=t.y+"px",o.style.width=t.x-e.x+"px",o.style.height=e.y-t.y+"px"},t(function(t,e){t.exports=function(){const p=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],u=1,c=8;class a{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[e,o]=new Uint8Array(t,0,2);if(e!==219)throw new Error("Data does not appear to be in a KDBush format.");const s=o>>4;if(s!==u)throw new Error(`Got v${s} data when expected v${u}.`);const n=p[o&15];if(!n)throw new Error("Unrecognized array type.");const[i]=new Uint16Array(t,2,1);const[r]=new Uint32Array(t,4,1);return new a(r,i,n,t)}constructor(t,e=64,o=Float64Array,s){if(isNaN(t)||t<=0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t;this.nodeSize=Math.min(Math.max(+e,2),65535);this.ArrayType=o;this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const n=p.indexOf(this.ArrayType);const i=t*2*this.ArrayType.BYTES_PER_ELEMENT;const r=t*this.IndexArrayType.BYTES_PER_ELEMENT;const a=(8-r%8)%8;if(n<0)throw new Error(`Unexpected typed array class: ${o}.`);if(s&&s instanceof ArrayBuffer){this.data=s;this.ids=new this.IndexArrayType(this.data,c,t);this.coords=new this.ArrayType(this.data,c+r+a,t*2);this._pos=t*2;this._finished=true}else{this.data=new ArrayBuffer(c+i+r+a);this.ids=new this.IndexArrayType(this.data,c,t);this.coords=new this.ArrayType(this.data,c+r+a,t*2);this._pos=0;this._finished=false;new Uint8Array(this.data,0,2).set([219,(u<<4)+n]);new Uint16Array(this.data,2,1)[0]=e;new Uint32Array(this.data,4,1)[0]=t}}add(t,e){const o=this._pos>>1;this.ids[o]=o;this.coords[this._pos++]=t;this.coords[this._pos++]=e;return o}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);l(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0);this._finished=true;return this}range(e,o,s,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:i,coords:r,nodeSize:t}=this;const a=[0,i.length-1,0];const p=[];while(a.length){const u=a.pop()||0;const c=a.pop()||0;const l=a.pop()||0;if(c-l<=t){for(let t=l;t<=c;t++){const m=r[2*t];const f=r[2*t+1];if(m>=e&&m<=s&&f>=o&&f<=n)p.push(i[t])}continue}const h=l+c>>1;const d=r[2*h];const g=r[2*h+1];if(d>=e&&d<=s&&g>=o&&g<=n)p.push(i[h]);if(u===0?e<=d:o<=g){a.push(l);a.push(h-1);a.push(1-u)}if(u===0?s>=d:n>=g){a.push(h+1);a.push(c);a.push(1-u)}}return p}within(e,o,t){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:s,coords:n,nodeSize:i}=this;const r=[0,s.length-1,0];const a=[];const p=t*t;while(r.length){const u=r.pop()||0;const c=r.pop()||0;const l=r.pop()||0;if(c-l<=i){for(let t=l;t<=c;t++)if(m(n[2*t],n[2*t+1],e,o)<=p)a.push(s[t]);continue}const h=l+c>>1;const d=n[2*h];const g=n[2*h+1];if(m(d,g,e,o)<=p)a.push(s[h]);if(u===0?e-t<=d:o-t<=g){r.push(l);r.push(h-1);r.push(1-u)}if(u===0?e+t>=d:o+t>=g){r.push(h+1);r.push(c);r.push(1-u)}}return a}}function l(t,e,o,s,n,i){if(n-s<=o)return;const r=s+n>>1;f(t,e,r,s,n,i);l(t,e,o,s,r-1,1-i);l(t,e,o,r+1,n,1-i)}function f(o,s,n,i,r,a){while(r>i){if(r-i>600){const u=r-i+1;const c=n-i+1;const l=Math.log(u);const h=.5*Math.exp(2*l/3);const d=.5*Math.sqrt(l*h*(u-h)/u)*(c-u/2<0?-1:1);const g=Math.max(i,Math.floor(n-c*h/u+d));const m=Math.min(r,Math.floor(n+(u-c)*h/u+d));f(o,s,n,g,m,a)}const p=s[2*n+a];let t=i;let e=r;x(o,s,i,n);if(s[2*r+a]>p)x(o,s,i,r);while(t<e){x(o,s,t,e);t++;e--;while(s[2*t+a]<p)t++;while(s[2*e+a]>p)e--}if(s[2*i+a]===p)x(o,s,i,e);else{e++;x(o,s,e,r)}if(e<=n)i=e+1;if(n<=e)r=e-1}}function x(t,e,o,s){n(t,o,s);n(e,2*o,2*s);n(e,2*o+1,2*s+1)}function n(t,e,o){const s=t[e];t[e]=t[o];t[o]=s}function m(t,e,o,s){const n=t-o;const i=e-s;return n*n+i*i}const e={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:false,generateId:false,reduce:null,map:t=>t},d=Math.fround||(e=>t=>{e[0]=+t;return e[0]})(new Float32Array(1)),v=2,M=3,_=4,C=5,h=6;class t{constructor(t){this.options=Object.assign(Object.create(e),t);this.trees=new Array(this.options.maxZoom+1);this.stride=this.options.reduce?7:6;this.clusterProps=[]}load(e){const{log:o,minZoom:s,maxZoom:n}=this.options;if(o)console.time("total time");const t=`prepare ${e.length} points`;if(o)console.time(t);this.points=e;const i=[];for(let t=0;t<e.length;t++){const a=e[t];if(!a.geometry)continue;const[p,u]=a.geometry.coordinates;const c=d(V(p));const l=d(w(u));i.push(c,l,Infinity,t,-1,1);if(this.options.reduce)i.push(0)}let r=this.trees[n+1]=this._createTree(i);if(o)console.timeEnd(t);for(let t=n;t>=s;t--){const h=+Date.now();r=this.trees[t]=this._createTree(this._cluster(r,t));if(o)console.log("z%d: %d clusters in %dms",t,r.numItems,+Date.now()-h)}if(o)console.timeEnd("total time");return this}getClusters(t,e){let o=((t[0]+180)%360+360)%360-180;const s=Math.max(-90,Math.min(90,t[1]));let n=t[2]===180?180:((t[2]+180)%360+360)%360-180;const i=Math.max(-90,Math.min(90,t[3]));if(t[2]-t[0]>=360){o=-180;n=180}else if(o>n){const c=this.getClusters([o,s,180,i],e);const l=this.getClusters([-180,s,n,i],e);return c.concat(l)}const r=this.trees[this._limitZoom(e)];const a=r.range(V(o),w(i),V(n),w(s));const p=r.data;const u=[];for(const h of a){const d=this.stride*h;u.push(p[d+C]>1?g(p,d,this.clusterProps):this.points[p[d+M]])}return u}getChildren(t){const e=this._getOriginId(t);const o=this._getOriginZoom(t);const s="No cluster with the specified id.";const n=this.trees[o];if(!n)throw new Error(s);const i=n.data;if(e*this.stride>=i.length)throw new Error(s);const r=this.options.radius/(this.options.extent*Math.pow(2,o-1));const a=i[e*this.stride];const p=i[e*this.stride+1];const u=n.within(a,p,r);const c=[];for(const l of u){const h=l*this.stride;if(i[h+_]===t)c.push(i[h+C]>1?g(i,h,this.clusterProps):this.points[i[h+M]])}if(c.length===0)throw new Error(s);return c}getLeaves(t,e,o){e=e||10;o=o||0;const s=[];this._appendLeaves(s,t,e,o,0);return s}getTile(t,e,o){const s=this.trees[this._limitZoom(t)];const n=Math.pow(2,t);const{extent:i,radius:r}=this.options;const a=r/i;const p=(o-a)/n;const u=(o+1+a)/n;const c={features:[]};this._addTileFeatures(s.range((e-a)/n,p,(e+1+a)/n,u),s.data,e,o,n,c);if(e===0)this._addTileFeatures(s.range(1-a/n,p,1,u),s.data,n,o,n,c);if(e===n-1)this._addTileFeatures(s.range(0,p,a/n,u),s.data,-1,o,n,c);return c.features.length?c:null}getClusterExpansionZoom(t){let e=this._getOriginZoom(t)-1;while(e<=this.options.maxZoom){const o=this.getChildren(t);e++;if(o.length!==1)break;t=o[0].properties.cluster_id}return e}_appendLeaves(t,e,o,s,n){const i=this.getChildren(e);for(const r of i){const a=r.properties;if(a&&a.cluster)if(n+a.point_count<=s)n+=a.point_count;else n=this._appendLeaves(t,a.cluster_id,o,s,n);else if(n<s)n++;else t.push(r);if(t.length===o)break}return n}_createTree(e){const o=new a(e.length/this.stride|0,this.options.nodeSize,Float32Array);for(let t=0;t<e.length;t+=this.stride)o.add(e[t],e[t+1]);o.finish();o.data=e;return o}_addTileFeatures(t,n,i,r,a,p){for(const u of t){const c=u*this.stride;const l=n[c+C]>1;let t,e,o;if(l){t=y(n,c,this.clusterProps);e=n[c];o=n[c+1]}else{const d=this.points[n[c+M]];t=d.properties;const[g,m]=d.geometry.coordinates;e=V(g);o=w(m)}const h={type:1,geometry:[[Math.round(this.options.extent*(e*a-i)),Math.round(this.options.extent*(o*a-r))]],tags:t};let s;if(l||this.options.generateId)s=n[c+M];else s=this.points[n[c+M]].id;if(s!==undefined)h.id=s;p.features.push(h)}}_limitZoom(t){return Math.max(this.options.minZoom,Math.min(Math.floor(+t),this.options.maxZoom+1))}_cluster(t,r){const{radius:e,extent:o,reduce:a,minPoints:s}=this.options;const p=e/(o*Math.pow(2,r));const u=t.data;const c=[];const l=this.stride;for(let i=0;i<u.length;i+=l){if(u[i+v]<=r)continue;u[i+v]=r;const h=u[i];const d=u[i+1];const g=t.within(u[i],u[i+1],p);const m=u[i+C];let n=m;for(const f of g){const x=f*l;if(u[x+v]>r)n+=u[x+C]}if(n>m&&n>=s){let t=h*m;let e=d*m;let o;let s=-1;const M=((i/l|0)<<5)+(r+1)+this.points.length;for(const y of g){const V=y*l;if(u[V+v]<=r)continue;u[V+v]=r;const w=u[V+C];t+=u[V]*w;e+=u[V+1]*w;u[V+_]=M;if(a){if(!o){o=this._map(u,i,true);s=this.clusterProps.length;this.clusterProps.push(o)}a(o,this._map(u,V))}}u[i+_]=M;c.push(t/n,e/n,Infinity,M,-1,n);if(a)c.push(s)}else{for(let t=0;t<l;t++)c.push(u[i+t]);if(n>1)for(const L of g){const b=L*l;if(u[b+v]<=r)continue;u[b+v]=r;for(let t=0;t<l;t++)c.push(u[b+t])}}}return c}_getOriginId(t){return t-this.points.length>>5}_getOriginZoom(t){return(t-this.points.length)%32}_map(t,e,o){if(t[e+C]>1){const i=this.clusterProps[t[e+h]];return o?Object.assign({},i):i}const s=this.points[t[e+M]].properties;const n=this.options.map(s);return o&&n===s?Object.assign({},n):n}}function g(t,e,o){return{type:"Feature",id:t[e+M],properties:y(t,e,o),geometry:{type:"Point",coordinates:[s(t[e]),i(t[e+1])]}}}function y(t,e,o){const s=t[e+C];const n=s>=1e4?`${Math.round(s/1e3)}k`:s>=1e3?`${Math.round(s/100)/10}k`:s;const i=t[e+h];const r=i===-1?{}:Object.assign({},o[i]);return Object.assign(r,{cluster:true,cluster_id:t[e+M],point_count:s,point_count_abbreviated:n})}function V(t){return t/360+.5}function w(t){const e=Math.sin(t*Math.PI/180);const o=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return o<0?0:o>1?1:o}function s(t){return(t-.5)*360}function i(t){const e=(180-t*360)*Math.PI/180;return 360*Math.atan(Math.exp(e))/Math.PI-90}return t}()}));Voxel.Maps.Clusterer.prototype.init=function({map:t}){this.map=t,this.markers=[],this.clusters={},this.cluster=new e({radius:35,maxZoom:30}),this.map.addListener("zoomend",()=>this.render())},Voxel.Maps.Clusterer.prototype._getGeoJSON=function(){return this.markers.map(function(t,e){return{type:"Feature",geometry:{type:"Point",coordinates:[t.getPosition().getLongitude(),t.getPosition().getLatitude()]},properties:{sID:e+1,scID:0,marker:t}}})},Voxel.Maps.Clusterer.prototype.getSourceObject=function(){return this.cluster},Voxel.Maps.Clusterer.prototype.clearMarkers=function(){this.markers.map(t=>t.remove()),this.markers=[]},Voxel.Maps.Clusterer.prototype.addMarkers=function(t){this.markers.push(...t)},Voxel.Maps.Clusterer.prototype.render=function(){var t=this._getGeoJSON();t.length?(this.cluster.load(t),this.markers.map(t=>t.remove()),t=this.cluster.getClusters([-180,-90,180,90],Math.floor(this.map.getSourceObject().getZoom())),this._removeFeatures(),this._displayFeatures(t)):this._removeFeatures()},Voxel.Maps.Clusterer.prototype._displayFeatures=function(t){t.forEach(e=>{var t,o;e.properties.cluster?(t=`<div><div class="ts-marker-cluster">${e.properties.point_count_abbreviated}</div></div>`,t=jQuery(t).get(0),(o=new mapboxgl.Marker(t)).setLngLat(e.geometry.coordinates),o.addTo(this.map.getSourceObject()),this.clusters[e.properties.cluster_id]=o,t.addEventListener("click",t=>{t.preventDefault(),Math.round(this.map.getZoom())>=this.map.getMaxZoom()?(t=this.cluster.getLeaves(e.properties.cluster_id,-1).map(t=>t.properties.marker),"function"==typeof this._onNonExpandableClusterClick&&this._onNonExpandableClusterClick(t)):(this.map.getSourceObject().easeTo({center:e.geometry.coordinates,zoom:this.cluster.getClusterExpansionZoom(e.properties.cluster_id)}),"function"==typeof this._onClusterClick&&this._onClusterClick())})):e.properties.marker.setMap(this.map)})},Voxel.Maps.Clusterer.prototype._removeFeatures=function(){Object.values(this.clusters).map(t=>t.remove())},Voxel.Maps.Clusterer.prototype.onClusterClick=function(t){this._onClusterClick=t},Voxel.Maps.Clusterer.prototype.onNonExpandableClusterClick=function(t){this._onNonExpandableClusterClick=t},jQuery(t=>{var e=document.getElementById("mapbox-gl-js");e&&(e.src=e.dataset.src,e.addEventListener("load",()=>{{mapboxgl.accessToken=Voxel_Config.mapbox?.api_key;let e=new i,o=Voxel_Config.mapbox.language;if(!(o&&-1<e.supportedLanguages.indexOf(o))){var s=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage,n=s&&s.split("-");let t=s;1<n.length&&(t=n[0]),o=-1<e.supportedLanguages.indexOf(t)?t:"en"}"ar"===o&&mapboxgl.setRTLTextPlugin("https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js",null,!0),Voxel_Config.mapbox.language=o,Voxel.Maps.MapboxSetLanguage=t=>{t=t.getSourceObject();t.setStyle(e.setLanguage(t.getStyle(),o))},Voxel.Maps.Loaded=!0,document.dispatchEvent(new Event("maps:loaded")),jQuery(document).on("voxel:markup-update",()=>{requestAnimationFrame(()=>jQuery(document).trigger("maps:loaded"))})}},{once:!0}))}),jQuery(document).on("maps:loaded",()=>{jQuery(".ts-map.ts-map-autoload").each((t,o)=>{if(!o.__map_loaded__){o.__map_loaded__=!0;var s=jQuery(o).data("config"),o={el:o,zoom:3};s&&(s.zoom&&(o.zoom=s.zoom),s.minZoom&&(o.minZoom=s.minZoom),s.maxZoom&&(o.maxZoom=s.maxZoom),s.center)&&(o.center=new Voxel.Maps.LatLng(s.center.lat,s.center.lng));let e=new Voxel.Maps.Map(o);s.markers&&s.markers.forEach(t=>{new Voxel.Maps.Marker({map:e,position:new Voxel.Maps.LatLng(t.lat,t.lng),template:t.uriencoded?decodeURIComponent(t.template):t.template})})}})})});
