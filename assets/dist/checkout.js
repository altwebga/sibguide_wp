!function(e){"function"==typeof define&&define.amd?define("checkout",e):e()}(function(){"use strict";var i={methods:{getSummary(){"direct_cart"===this.source?this._getDirectCartSummary():this._getCartSummary()},storeGuestCart(){if(Object.keys(this.items).length){let t={};Object.values(this.items).forEach(e=>t[e.key]=e.value),localStorage.setItem("voxel:guest_cart",JSON.stringify(t))}else localStorage.removeItem("voxel:guest_cart")},_getCartSummary(){this.is_logged_in?jQuery.post(Voxel_Config.ajax_url+"&action=products.get_cart_items",{_wpnonce:this.config.nonce.cart,guest_cart:localStorage.getItem("voxel:guest_cart")}).always(e=>{this.$options.el.closest(".elementor-element").querySelector(".ts-checkout-loading")?.classList.add("hidden"),this.loading=!1,localStorage.removeItem("voxel:guest_cart"),e.success?(this.items=e.items,this.setupShipping()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}):jQuery.post(Voxel_Config.ajax_url+"&action=products.get_guest_cart_items",{_wpnonce:this.config.nonce.cart,guest_cart:localStorage.getItem("voxel:guest_cart")}).always(e=>{this.$options.el.closest(".elementor-element").querySelector(".ts-checkout-loading")?.classList.add("hidden"),this.loading=!1,e.success?(this.items=Object.keys(e.items).length?e.items:{},this.storeGuestCart(),this.setupShipping()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},_getDirectCartSummary(){var e=Voxel.getSearchParam("checkout_item");let t=null;try{t=JSON.parse(localStorage.getItem("voxel:direct_cart"))}catch(e){}jQuery.get(Voxel_Config.ajax_url+"&action=products.get_direct_cart",{_wpnonce:this.config.nonce.cart,item:JSON.stringify(t?.[e])}).always(e=>{this.$options.el.closest(".elementor-element").querySelector(".ts-checkout-loading")?.classList.add("hidden"),this.loading=!1,e.success?(this.items={[e.item.key]:e.item},this.cart_context=e.metadata.cart_context,this.proof_of_ownership.status=e.metadata.proof_of_ownership,this.setupShipping()):(this.items={},Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})},hasItems(){return!1===this.loading&&Object.keys(this.items).length},getItemQuantity(e){return"regular"===e.product_mode?e.value.stock.quantity:"variable"===e.product_mode?e.value.variations.quantity:null}}},r={methods:{submitQuickRegister(){this.recaptcha("vx_checkout_quick_register",e=>{this.processing=!0,jQuery.post({url:Voxel_Config.ajax_url+"&action=products.quick_register.process",data:{guest_cart:localStorage.getItem("voxel:guest_cart"),email:this.quick_register.email,terms_agreed:this.quick_register.terms_agreed?"yes":"",_confirmation_code:this.quick_register.code,_wpnonce:this.config.nonce.checkout,_recaptcha:e}}).always(e=>{e.success?(this.quick_register.registered=!0,this.config.nonce.cart=e.nonces.cart,this.config.nonce.checkout=e.nonces.checkout,localStorage.removeItem("voxel:guest_cart"),this.checkout()):(this.processing=!1,Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})})},sendEmailVerificationCode(){this.recaptcha("vx_checkout_send_confirmation_code",e=>{this.quick_register.sending_code=!0,jQuery.post({url:Voxel_Config.ajax_url+"&action=products.quick_register.send_confirmation_code",data:{email:this.quick_register.email,_wpnonce:this.config.nonce.checkout,_recaptcha:e}}).always(e=>{this.quick_register.sending_code=!1,e.success?"email_exists"===e.status?Voxel.alert(e.message,"info",[{link:this.config.auth_link,label:Voxel_Config.l10n.login}]):(this.quick_register.sent_code=!0,Voxel.alert(e.message,"info",[],2e3),this.$nextTick(()=>this.$refs.emailConfirmCode?.focus())):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})})},recaptcha(e,t){this.config.recaptcha.enabled?grecaptcha.ready(()=>{grecaptcha.execute(this.config.recaptcha.key,{action:e}).then(e=>t(e))}):t(null)}}},o={methods:{getShippingMethod(){var e,t;return!this.config.multivendor.enabled||"vendor"!==this.config.shipping.responsibility||(e=this.vendors,1===(t=Object.keys(e).length)&&e.platform)?"platform_rates":1<=t?"vendor_rates":null},setupShipping(){var e;"pending_setup"===this.shipping.status&&(this.shipping.status="processing",this.hasShippableProducts()?null!==(e=this.config.shipping.default_country)&&this.shippingCountries[e]?(this.shipping.status="completed",this.setShippingCountry(e)):this.config.geoip_providers.length?this.geocodeCountry().then(e=>{null!==e&&this.shippingCountries[e]?this.setShippingCountry(e):Object.keys(this.shippingCountries)&&this.setShippingCountry(Object.keys(this.shippingCountries)[0]),this.shipping.status="completed"}):(Object.keys(this.shippingCountries)&&this.setShippingCountry(Object.keys(this.shippingCountries)[0]),this.shipping.status="completed"):this.shipping.status="completed")},async geocodeCountry(){for(var e of this.config.geoip_providers)try{var t=await jQuery.get(e.url);if(t?.[e.prop]){var i=t[e.prop];if("string"==typeof i)return document.cookie=`_vx_ccode=${i}; max-age:259200; path=/`,i.toUpperCase()}}catch(e){}return null},shippingCountryUpdated(e){this.shipping.country=null,this.shipping.zone=null,this.shipping.rate=null,e.target.value&&this.setShippingCountry(e.target.value)},setShippingCountry(e){var t;if(this.shipping.country=e,"vendor_rates"===this.getShippingMethod())Object.values(this.vendors).forEach(e=>{var t;if(this.shipping.vendors[e.key]=null,e.has_shippable_products&&e.shipping_zones&&e.shipping_countries)e:for(var i of Object.values(e.shipping_zones))if(i.countries[this.shipping.country])for(t of Object.values(i.rates))if(this.shouldListVendorShippingRate(e,t,i)&&this.vendorRateMeetsCriteria(e,t,i)){this.shipping.vendors[e.key]={zone:i.key,rate:t.key};break e}});else e:for(var i of Object.values(this.config.shipping.zones))if(i.countries[this.shipping.country])for(t of Object.values(i.rates))if(this.shouldListShippingRate(t,i)&&this.rateMeetsCriteria(t,i)){this.shipping.zone=i.key,this.shipping.rate=t.key;break e}},shouldListShippingRate(e,t){return!!t.countries[this.shipping.country]},rateMeetsCriteria(e,t){if("free_shipping"!==e.type)return"fixed_rate"===e.type;if("minimum_order_amount"!==e.requirements)return!0;{let t=0;var i;return Object.values(this.items).forEach(e=>t+=e.pricing.total_amount),this.hasShippableProducts()&&this.isShippingSelected()&&null!==(i=this.getShippingTotalForRate(e))&&(t+=i),t>=e.minimum_order_amount}},shouldListVendorShippingRate(e,t,i){return!!i.countries[this.shipping.country]},vendorRateMeetsCriteria(i,e,t){if("free_shipping"!==e.type)return"fixed_rate"===e.type;if("minimum_order_amount"!==e.requirements)return!0;{let t=0;var s;return Object.values(this.items).forEach(e=>{e.vendor.id===i.id&&(t+=e.pricing.total_amount)}),i.has_shippable_products&&this.isVendorShippingSelected(i)&&null!==(s=this.getVendorShippingTotalForRate(i,e))&&(t+=s),t>=e.minimum_order_amount}},getShippingTotalForRate(i){if("free_shipping"===i.type)return 0;if("fixed_rate"!==i.type)return null;{var s;let t=0;for(s of Object.values(this.items))if(s.shipping.is_shippable){let e=i.amount_per_unit;var r=s.shipping.shipping_class;r&&i.shipping_classes[r]&&(e=i.shipping_classes[r]),s.quantity.enabled?(r=this.getItemQuantity(s),t+=e*r):t+=e}return t}},getVendorShippingTotalForRate(e,i){if("free_shipping"===i.type)return 0;if("fixed_rate"!==i.type)return null;{var s;let t=0;for(s of Object.values(this.items))if(s.vendor.id===e.id&&s.shipping.is_shippable){let e=i.amount_per_unit;var r=s.shipping.shipping_class;r&&i.shipping_classes[r]&&(e=i.shipping_classes[r]),s.quantity.enabled?(r=this.getItemQuantity(s),t+=e*r):t+=e}return t}},isVendorShippingSelected(e){return!!(this.shipping.country&&this.shipping.vendors[e.key]?.zone&&this.shipping.vendors[e.key]?.rate)&&!!e.shipping_zones[this.shipping.vendors[e.key].zone].countries[this.shipping.country]&&!!e.shipping_zones[this.shipping.vendors[e.key].zone].rates[this.shipping.vendors[e.key].rate]},getVendorShippingTotal(e){return e.has_shippable_products&&this.isVendorShippingSelected(e)?this.getVendorShippingTotalForRate(e,e.shipping_zones[this.shipping.vendors[e.key].zone].rates[this.shipping.vendors[e.key].rate]):null}},computed:{shippingCountries(){if("vendor_rates"!==this.getShippingMethod())return this.config.shipping.countries;{let i={};for(let t of Object.values(this.items))t.shipping.is_shippable&&t.vendor.shipping_countries&&Object.keys(t.vendor.shipping_countries).forEach(e=>{i[e]=t.vendor.shipping_countries[e]}),t.shipping.is_shippable&&null===t.vendor.id&&Object.keys(this.config.shipping.countries).forEach(e=>{i[e]=this.config.shipping.countries[e]});return i}}}},s={template:"#vx-file-upload",props:{field:Object,sortable:{type:Boolean,default:!0},allowedFileTypes:String,maxFileCount:{type:Number,default:1},modelValue:Array,context:Object},emits:["update:modelValue"],data(){return{dragActive:!1,reordering:!1,value:this.modelValue,id:"file-upload-"+Voxel.helpers.sequentialId()}},mounted(){jQuery(this.$refs.input).on("change",e=>{for(var t=0;t<e.target.files.length;t++){var i=e.target.files[t];this.pushFile(i)}this.$refs.input.value="",this.update()})},unmounted(){setTimeout(()=>{Array.isArray(this.value)&&this.value.forEach(e=>{"new_upload"===e.source&&URL.revokeObjectURL(e.preview)})},10)},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},pushFile(t){1===this.maxFileCount&&(this.value=[]);var e={source:"new_upload",name:t.name,type:t.type,size:t.size,preview:URL.createObjectURL(t),item:t,_id:Voxel.helpers.randomId(8)},i=(void 0===window._vx_file_upload_cache&&(window._vx_file_upload_cache=[]),window._vx_file_upload_cache.find(e=>e.item.name===t.name&&e.item.type===t.type&&e.item.size===t.size&&e.item.lastModified===t.lastModified));i?this.value.push(i):(this.value.push(e),window._vx_file_upload_cache.unshift(e))},onDrop(e){this.dragActive=!1,e.dataTransfer.items?[...e.dataTransfer.items].forEach(e=>{"file"===e.kind&&this.pushFile(e.getAsFile())}):[...e.dataTransfer.files].forEach(e=>{this.pushFile(e)}),this.update()},onMediaPopupSave(e){1===this.maxFileCount&&(this.value=[]);var t={};this.value.forEach(e=>{"existing"===e.source&&(t[e.id]=!0),"new_upload"===e.source&&(t[e._id]=!0)}),Object.values(e).forEach(e=>{"existing"!==e.source||t[e.id]||this.value.push(e),"new_upload"!==e.source||t[e._id]||this.value.push(e)}),this.update()},update(){this.$emit("update:modelValue",this.value)}},watch:{modelValue(e){this.value=e}}},n={template:"#vx-cart-item",props:{checkout:Object,item:Object},methods:{plusOne(){var e=this.checkout.getItemQuantity(this.item)+1;this.setQuantity(e)},minusOne(){var e=this.checkout.getItemQuantity(this.item)-1;e<=0?this.removeItem():this.setQuantity(e)},removeItem(){"direct_cart"===this.checkout.source?(this.checkout.items={},localStorage.removeItem("voxel:direct_cart"),Voxel.deleteSearchParam("checkout_item")):this.checkout.is_logged_in||!1!==this.checkout.quick_register.registered?(this.item._disabled=!0,jQuery.post(Voxel_Config.ajax_url+"&action=products.remove_cart_item",{item_key:this.item.key,_wpnonce:this.checkout.config.nonce.cart}).always(e=>{e.success?delete this.checkout.items[this.item.key]:(this.item._disabled=!1,Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})):(delete this.checkout.items[this.item.key],this.checkout.storeGuestCart())},setQuantity(e){var t;"direct_cart"===this.checkout.source?(this.item._disabled=!0,jQuery.post(Voxel_Config.ajax_url+"&action=products.get_direct_cart",{item:JSON.stringify(this.item.value),item_quantity:e,_wpnonce:this.checkout.config.nonce.cart}).always(e=>{this.item._disabled=!1,e.success?this.checkout.items={[e.item.key]:e.item}:Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})):(this.item._disabled=!0,t=this.checkout.is_logged_in||!1!==this.checkout.quick_register.registered?"products.update_cart_item_quantity":"products.update_guest_cart_item_quantity",jQuery.post(Voxel_Config.ajax_url+"&action="+t,{item_key:this.item.key,item_quantity:e,guest_cart:this.checkout.is_logged_in||!1!==this.checkout.quick_register.registered?null:localStorage.getItem("voxel:guest_cart"),_wpnonce:this.checkout.config.nonce.cart}).always(e=>{this.item._disabled=!1,e.success?(this.checkout.items[this.item.key]=e.item,this.checkout.is_logged_in||!1!==this.checkout.quick_register.registered||this.checkout.storeGuestCart()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}))},hasStockLeft(){let e=this.item.quantity.max;for(var t of Object.values(this.checkout.items))if(t.stock_id===this.item.stock_id&&(e-=this.checkout.getItemQuantity(t))<=0)return!1;return!0}}};window.render_voxel_checkout=()=>{Array.from(document.querySelectorAll(".ts-checkout.ts-checkout-regular")).forEach(e=>{var t;e.__vue_app__||(t=JSON.parse(e.closest(".elementor-element").querySelector(".vxconfig").innerHTML),(t=((e,s)=>{let t=Voxel_Config.is_logged_in;return Vue.createApp({el:e,mixins:[Voxel.mixins.base,i,r,o],data(){return{is_logged_in:t,config:s,loading:!0,processing:!1,items:null,source:"cart",cart_context:null,order_notes:{enabled:!1,content:""},proof_of_ownership:{status:"disabled",enabled:!1,files:[]},quick_register:{email:"",sending_code:!1,sent_code:!1,code:"",registered:!1,terms_agreed:!1},shipping:{country:null,zone:null,rate:null,status:"pending_setup",vendors:{}}}},created(){window.VX_Cart_Summary=this,Voxel.getSearchParam("checkout_item")?this.source="direct_cart":this.source="cart",this.getSummary()},methods:{currencyFormat(){return Voxel.helpers.currencyFormat(...arguments)},getSubtotal(){let t=0;Object.values(this.items).forEach(e=>{t+=e.pricing.total_amount});var e=this.getShippingTotal();return null!==e&&(t+=e),t},getShippingTotal(){if(!this.hasShippableProducts())return null;if(!this.isShippingSelected())return null;if("vendor_rates"!==this.getShippingMethod())return this.getShippingTotalForRate(this.config.shipping.zones[this.shipping.zone].rates[this.shipping.rate]);{let t=0;return Object.values(this.vendors).forEach(e=>{e=this.getVendorShippingTotal(e);null!==e&&(t+=e)}),t}},isShippingSelected(){if("vendor_rates"!==this.getShippingMethod())return!!(this.shipping.country&&this.shipping.zone&&this.shipping.rate)&&!!this.config.shipping.zones[this.shipping.zone].countries[this.shipping.country]&&!!this.config.shipping.zones[this.shipping.zone].rates[this.shipping.rate];var e;for(e of Object.values(this.vendors))if(e.has_shippable_products&&!this.isVendorShippingSelected(e))return!1;return!0},hasShippableProducts(){var e;for(e of Object.values(this.items))if(e.shipping.is_shippable)return!0;return!1},submit(){t||"proceed_with_email"!==this.config.guest_customers.behavior||!1!==this.quick_register.registered?this.checkout():this.submitQuickRegister()},checkout(){this.processing=!0;let i=new FormData;if(i.append("source",this.source),i.append("items",JSON.stringify(Object.values(this.items).map(e=>e.value))),this.order_notes.enabled&&i.append("order_notes",this.order_notes.content),"required"===this.proof_of_ownership.status||this.proof_of_ownership.enabled){var e=this.proof_of_ownership.files;let t=[];e.forEach(e=>{"new_upload"===e.source?(i.append("files[proof_of_ownership][]",e.item),t.push("uploaded_file")):"existing"===e.source&&t.push(e.id)}),i.append("proof_of_ownership",JSON.stringify(t))}"vendor_rates"===this.getShippingMethod()?i.append("shipping",JSON.stringify({country:this.shipping.country,vendors:this.shipping.vendors})):i.append("shipping",JSON.stringify({country:this.shipping.country,zone:this.shipping.zone,rate:this.shipping.rate})),jQuery.post({url:Voxel_Config.ajax_url+"&action=products.checkout&_wpnonce="+s.nonce.checkout,data:i,contentType:!1,processData:!1}).always(e=>{this.processing=!1,e.success?window.location.href=e.redirect_url:Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},resizeComposer(){this.$refs.orderNotes&&(this.$refs._orderNotes.value=this.$refs.orderNotes.value,this.$refs._orderNotes.style.width=this.$refs.orderNotes.scrollWidth+"px",this.$refs._orderNotes.style.minWidth=this.$refs.orderNotes.scrollWidth+"px",this.$refs._orderNotes.style.maxWidth=this.$refs.orderNotes.scrollWidth+"px",this.$refs.orderNotes.style.height=this.$refs._orderNotes.scrollHeight+"px")},toggleComposer(){this.order_notes.enabled?this.order_notes.enabled=!1:(this.order_notes.enabled=!0,this.$nextTick(()=>{this.resizeComposer(),this.$refs.orderNotes?.focus()}))},canProceedWithPayment(){return!(this.hasShippableProducts()&&!this.isShippingSelected()||!t&&("proceed_with_email"!==this.config.guest_customers.behavior||!/^\S+@\S+\.\S+$/.test(this.quick_register.email)||this.config.guest_customers.proceed_with_email.require_verification&&!(this.quick_register.sent_code&&6<=this.quick_register.code?.length)||this.config.guest_customers.proceed_with_email.require_tos&&!this.quick_register.terms_agreed))},shouldGroupItemsByVendor(){var e=this.vendors,t=Object.keys(e).length;return!(!(this.config.multivendor.enabled&&1<=t)||1===t&&e.platform)}},computed:{vendors(){let i={};return this.items&&Object.values(this.items).forEach(e=>{var t=null===e.vendor.id?"platform":"vendor_"+e.vendor.id;i[t]||(i[t]={id:e.vendor.id,display_name:e.vendor.display_name,vendor_key:t,key:t,items:{},has_shippable_products:!1,shipping_zones:"platform"==t?s.shipping.zones:e.vendor.shipping_zones,shipping_countries:"platform"==t?s.shipping.countries:e.vendor.shipping_countries}),(i[t].items[e.key]=e).shipping.is_shippable&&(i[t].has_shippable_products=!0)}),i}}})})(e,t)).component("file-upload",s),t.component("cart-item",n),t.mount(e))}),Array.from(document.querySelectorAll(".ts-checkout.ts-checkout-promotion")).forEach(e=>{var t,i;e.__vue_app__||(t=JSON.parse(e.closest(".elementor-element").querySelector(".vxconfig").innerHTML),i=t,Vue.createApp({el:e,mixins:[Voxel.mixins.base],data(){return{config:i,loading:!0,processing:!1,selected:null}},created(){this.selected=this.config.packages[Object.keys(this.config.packages)[0]]},methods:{currencyFormat(){return Voxel.helpers.currencyFormat(...arguments)},checkout(){this.processing=!0,jQuery.post({url:Voxel_Config.ajax_url+"&action=products.promotions.checkout&_wpnonce="+i.nonce.checkout,data:{post_id:this.config.post_id,promotion_package:this.selected.key}}).always(e=>{this.processing=!1,e.success?window.location.href=e.redirect_url:Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}}}).mount(e))})},window.render_voxel_checkout(),jQuery(document).on("voxel:markup-update",window.render_voxel_checkout)});
