!function(t){"function"==typeof define&&define.amd?define("dynamicData",t):t()}(function(){"use strict";var s={template:"#vx-dynamic-mode-edit-content",components:{"edit-tag":{template:"#vx-dynamic-edit-tag",props:{token:Object},data(){return{details:{},modifiers:[],newModifier:null}},created(){this.details=this.$root.getTokenDetails(this.token);var e,s=this.details.group;for(e of this.token.modifiers){let t=null;if(t=s&&s.group.methods[e.key]?structuredClone(Vue.toRaw(s.group.methods[e.key])):this.$root.Dynamic_Data_Store.modifiers[e.key]?structuredClone(Vue.toRaw(this.$root.Dynamic_Data_Store.modifiers[e.key])):{unknown:!0,key:e.key,label:e.key,arguments:[],expects:[],type:"modifier"},1!==e.args.length||""!==e.args[0].content)for(var r in e.args){var i=e.args[r].content;t.arguments[r]?"string"==typeof i&&""!==i&&(t.arguments[r].value=i):t.arguments[r]={type:"unknown",value:i}}t._id=Voxel_Backend.helpers.randomId(),this.modifiers.push(t)}this.$watch(()=>this.modifierArgs,()=>this.saveTag())},methods:{getDisplayLabel(){var{group:t,property:e}=this.details;return null===t?"Unknown group":0===this.token.props.length||1===this.token.props.length&&""===this.token.props[0]?t.label:null===e?"Unknown tag":e.label},getDisplayPath(){var t,{group:e,ancestors:s,property:r}=this.details,i=[];if(null===e||null===r)return[];i.push({textContent:e.label});for(t of s)i.push({title:t.description,textContent:t.label});return i.push({title:r.description,textContent:r.label}),i},toggleModifier(t){t._open?t._open=!1:(this.modifiers.map(t=>t._open=!1),t._open=!0)},getValidArgs(t){return t.arguments.filter(t=>"unknown"!==t.type)},hasInvalidArgs(t){return!!t.arguments.find(t=>"unknown"===t.type)},getInvalidArgs(t){return t.arguments.filter(t=>"unknown"===t.type)},getAvailableModifiers(){const{group:t,ancestors:s}=this.details;if(!t)return[];s.at(-1);var e=this.$root.Dynamic_Data_Store.modifiers,r=t.group.methods;const i={string:{label:"Text",items:[]},number:{label:"Number",items:[]},date:{label:"Date",items:[]},other:{label:"Other",items:[]},conditionals:{label:"Conditionals",items:[]}},o=(Object.values(e).forEach(t=>{let e=t.expects[0];i[e]||(e="other"),"control-structure"===t.type&&(e="conditionals","else"===t.key||"then"===t.key)||["list","count"].includes(t.key)&&!s.some(t=>"object-list"===t.type)||i[e].items.push(t)}),Object.values(r).forEach(t=>{i.other.items.push(t)}),{});return Object.keys(i).forEach(t=>{var e=i[t];e.items.length&&(o[t]=e)}),o},saveTag(){let t=`@${this.token.group_key}(${this.token.raw_props})`;for(var e of this.modifiers){for(var s=e.arguments.map(t=>this.$root.escapeModifierArgument(t.value));0<s.length&&""===s[s.length-1];)s.pop();t+=`.${e.key}(${s.join(",")})`}this.$emit("tag-updated",{tag:t})}},computed:{modifierArgs(){return this.modifiers.map(t=>t.arguments.map(t=>t.value))}},watch:{newModifier(t){var e;t&&((t=structuredClone(Vue.toRaw(t)))._id=Voxel_Backend.helpers.randomId(),this.modifiers.push(t),"control-structure"===t.type)&&(t=this.$root.Dynamic_Data_Store.modifiers,(e=structuredClone(Vue.toRaw(t.then)))._id=Voxel_Backend.helpers.randomId(),this.modifiers.push(e),(e=structuredClone(Vue.toRaw(t.else)))._id=Voxel_Backend.helpers.randomId(),this.modifiers.push(e)),this.$nextTick(()=>{this.newModifier=null})}}}},props:{modelValue:{type:String,default:""}},data(){return{content:this.modelValue,search:"",editTag:{token:null,startIndex:null,endIndex:null}}},created(){},methods:{onTokenFocus(e){this.editTag.token=null,this.editTag.startIndex=null,this.editTag.endIndex=null,this.$nextTick(()=>{var t=e.token;"dynamic-tag"===t?.getType?.()&&(this.editTag.token=t,this.editTag.startIndex=e.startIndex,this.editTag.endIndex=e.startIndex+t.getLength())})},onTagUpdate(t){var t=t.tag,e=this.content.substr(0,this.editTag.startIndex),s=this.content.substr(this.editTag.endIndex);this.content=e+t+s,this.editTag.endIndex=this.editTag.startIndex+t.length},searchBlurred(){Array.from(this.$refs.sideTags.querySelectorAll("li > span")).forEach((t,e)=>{t.classList.contains("is-active")&&t.classList.remove("is-active")})},searchBeforeInput(t){this.$refs.mainGroupList.suspendTransitions(300)},searchTagSelected(t){var e=this.$refs.codeEditor;const s=e.$refs.editor;var r=s.selectionStart,i=s.selectionEnd,r=e.content.substr(0,r),i=e.content.substr(i);e.content=r+t+i;let o=(r+t).length;e.hideDropdown(),e.$nextTick(()=>{s.selectionStart=s.selectionEnd=o,s.focus()})},focusEditor(){(this.$refs.codeEditor?.$refs.editor)?.focus()},searchNavigateTags(t){"ArrowDown"===t.key?(t.preventDefault(),this.$refs.mainGroupList.focusNextItem()):"ArrowUp"===t.key?(t.preventDefault(),this.$refs.mainGroupList.focusPrevItem()):"Enter"===t.key&&(t.preventDefault(),this.$refs.mainGroupList.clickFocusedItem())},save(){this.$root.visible=!1,this.$root.groups=null,this.$root.emitter.emit("save")},discard(){this.$root.visible=!1,this.$root.groups=null,this.$root.searchDataSet=null,this.$root.emitter.emit("discard")}},watch:{content(t,e){this.$emit("update:modelValue",this.content)},modelValue(t){this.content=t}}},r={template:"#vx-dynamic-mode-edit-visibility",props:{modelValue:{type:Array,default:[]}},data(){return{rules:this.modelValue}},created(){},methods:{addRuleGroup(){this.rules.push([{type:null}])},addRule(t){t.push({type:null})},removeRule(t,e,s){e.splice(t,1),0===e.length&&1<this.rules.length&&this.rules.splice(s,1)},onRuleTypeChange(e){const s=this.$root.Dynamic_Data_Store.visibility_rules[e.type]||null;null===s?Object.keys(e).forEach(t=>{"type"!==t&&delete e[t]}):(Object.keys(e).forEach(t=>{"type"!==t&&void 0===s.arguments[t]&&delete e[t]}),Object.keys(s.arguments).forEach(t=>{void 0===e[t]&&(e[t]=structuredClone(s.arguments[t].value))}))},getRuleArguments(t){t=this.$root.Dynamic_Data_Store.visibility_rules[t.type]||null;return null===t?{}:t.arguments},evaluateRuleConditions(t,e){if("string"!=typeof e||!e.length)return!0;try{return new Function("rule","return "+e)(t)}catch(t){return console.warn("Invalid v-if condition:",e,t),!1}},dtagGetCompareArguments(t){t=this.$root.Dynamic_Data_Store.modifiers[t.compare]||null;return t&&"control-structure"===t.type?t.arguments:[]},sanitizeRules(t){if(!Array.isArray(t))return[];const e=[];return t.forEach(t=>{if(Array.isArray(t)){const s=[];t.forEach(t=>{var e;"object"!=typeof t||null===t||"string"!=typeof t.type&&null!==t.type||("dtag"===t.type&&(e=this.dtagGetCompareArguments(t),Array.isArray(t.arguments)||("object"==typeof t.arguments&&null!==t.arguments?t.arguments=Object.values(t.arguments):t.arguments=[]),0===e.length?t.arguments=[]:t.arguments.length>e.length&&(t.arguments=t.arguments.slice(0,e.length-1))),s.push(t))}),s.length&&e.push(s)}}),e},setRules(t){this.rules=this.sanitizeRules(t),this.rules=this.rules.map(t=>t.map(t=>("dtag"===t.type&&(t.tag=this.$root.unescapeModifierArgument(t.tag),t.arguments=t.arguments.map(t=>this.$root.unescapeModifierArgument(t))),t)))},canAddRuleGroup(){if(0===this.rules.length)return!0;for(var t of this.rules)for(var e of t)if("object"==typeof e&&null!==e&&null!==e.type)return!0;return!1},save(){this.rules=this.sanitizeRules(this.rules),this.rules=this.rules.map(t=>t.map(t=>("dtag"===t.type&&(t.tag=this.$root.escapeModifierArgument(t.tag),t.arguments=t.arguments.map(t=>this.$root.escapeModifierArgument(t))),t)).filter(t=>null!==t.type&&""!==t.type)).filter(t=>t.length),this.$root.visible=!1,this.$root.groups=null,this.$root.emitter.emit("save",JSON.parse(JSON.stringify(this.rules)))},discard(){this.$root.visible=!1,this.$root.groups=null,this.$root.searchDataSet=null,this.$root.emitter.emit("discard")}},watch:{rules(t,e){this.$emit("update:modelValue",this.rules)},modelValue(t){this.rules=t}}},i={template:"#vx-dynamic-mode-edit-loop",props:{modelValue:{type:String,default:null}},data(){return{selected:this.modelValue,groups:{},activeGroup:null}},created(){this.getLoopables()},mounted(){if("string"==typeof this.selected){var t=this.$root.tokenizer.tokenize(this.selected);if(1===t.length&&"dynamic-tag"===t[0]?.getType?.()){const i=t[0];this.groups[i.group_key]&&(this.activeGroup=this.groups[i.group_key],this.$nextTick(()=>{let e=this.$refs["propList:"+i.group_key]?.[0]||null,s=0,r=()=>{if(!i.props[s])return null;var t=i.props[s];null!==e&&e.properties[t]&&(e.activeProperty=e.properties[t],this.$nextTick(()=>{e=e.$refs.propList?.[0]||null,s++,r()}))};r()}))}}},methods:{getLoopables(){this.groups=structuredClone(Vue.toRaw(this.$root.groups)),Object.values(this.groups).forEach(e=>{Object.values(e.group.exports).forEach(t=>{"object-list"===t.type&&(e._has_loopables=!0),this.hasLoopableDescendats(t)&&(t._has_loopables=!0,e._has_loopables=!0)})})},hasLoopableDescendats(t,e=0){let s=!1;if(t.subgroup){if(1<=e)return!1;t.exports=structuredClone(this.$root.Dynamic_Data_Store.groups[t.subgroup.key].exports),e++}for(const r in t.exports)["object","object-list"].includes(t.exports[r].type)&&this.hasLoopableDescendats(t.exports[r],e)&&(s=!0,t.exports[r]._has_loopables=!0),"object-list"===t.exports[r].type&&(s=!0);return s},onSelect(t){this.selected=t.tag,this.$emit("update:modelValue",this.selected),this.$root.visible=!1,this.$root.groups=null,this.$root.emitter.emit("save")},discard(){this.$root.visible=!1,this.$root.groups=null,this.$root.searchDataSet=null,this.$root.emitter.emit("discard")}},watch:{modelValue(t){this.selected=t}}};class g{constructor(t){this.text=t}getType(){return"plain-text"}getText(){return this.text}getLength(){return this.text.length}getTokenAtOffset(t){return this}highlighted(){return this.getText()}}class e{constructor(t){this.content=t.content,this.dynamic=t.dynamic,this.raw=t.raw,this.parent=null}getType(){return"modifier-arg"}toScript(){return this.raw}getLength(){return this.toScript().length}getTokenAtOffset(e){if(this.dynamic){var s,r;let t=0;for(s of Voxel_Dynamic.tokenizer.tokenize(this.raw))if(e<=(t+=s.getLength()))return s.parent=this,r=e-(t-s.getLength()),s.subOffset=r,s.getTokenAtOffset(r)}return this}}class o{constructor(t){this.key=t.key,this.args=t.args.map(t=>{t=new e(t);return t.parent=this,t}),this.raw_args=t.raw_args,this.parent=null}getType(){return"modifier"}toScript(){return`.${this.key}(${this.args.map(t=>t.raw).join(",")})`}getLength(){return this.toScript().length}getTokenAtOffset(t){let e=0;var s,r=`.${this.key}(`;if(!(t<=(e+=r.length)))for(var i of this.args){if(t<=(e+=i.getLength()))return s=t-(e-i.getLength()),i.subOffset=s,i.getTokenAtOffset(s);e+=1}return this}}class f{constructor(t){this.group_key=t.group_key,this.props=t.props,this.raw_props=t.raw_props,this.modifiers=t.modifiers.map(t=>{t=new o(t);return t.parent=this,t}),this.parent=null}getType(){return"dynamic-tag"}addModifier(t){t=new o(t);(t.parent=this).modifiers.push(t)}toScript(){let t=`@${this.group_key}(${this.raw_props})`;for(var e of this.modifiers)t+=`.${e.key}(${e.raw_args})`;return t}getLength(){return this.toScript().length}getTokenAtOffset(t,e=!0){let s=0;var r,i=`@${this.group_key}(${this.raw_props})`;if(!(t<=(s+=i.length)))for(var o of this.modifiers)if(t<=(s+=o.getLength()))return r=t-(s-o.getLength()),o.subOffset=r,e?o.getTokenAtOffset(r):o;return this}highlighted(){let t=`@${this.group_key}(`;var s,e;this.raw_props&&(e=this.raw_props.split("\n"),t+='<span class="hl-group-props">'+e.join('</span>\n<span class="hl-group-props">')+"</span>"),t+=")";let r="";for(s of this.modifiers){r+=`.${s.key}(`;let e=[];s.args.forEach(t=>{var t=t.toScript();""===t?e.push(t):(t=t.split("\n"),e.push('<span class="hl-group-arg">'+t.join('</span>\n<span class="hl-group-arg">')+"</span>"))}),r=r+e.join(",")+")"}return r&&(e=r.split("\n"),t+='<span class="hl-group-mods">'+e.join('</span>\n<span class="hl-group-mods">')+"</span>"),'<span class="hl-group">'+t.split("\n").join('</span>\n<span class="hl-group">')+"</span>"}}var n={tokenize:function(t){var o={")":!0,".":!0,"\\":!0},n={"(":!0,")":!0,",":!0,"\\":!0},a=[...t],l=a.length,h=[];let u=0;t:for(;u<l;)if("@"===a[u]){u++;let i="",t=0;for(;u<l&&t<=32&&"("!==a[u];){if("@"===a[u]){h.push(new g("@"+i));continue t}i+=a[u],t++,u++}if(u>=l||"("!==a[u]||!/^[a-zA-Z0-9_]+$/.test(i))h.push(new g("@"+i));else{u++;let t=0;var p=[];let e=p[0]="",s=0,r=0;for(;u<l&&s<=60&&r<=240&&(r++,")"!==a[u]);)"."===a[u]?(e+=".",s=0,p[++t]="",u++):"\\"===a[u]&&o[a[u+1]||""]?(e+=a[u]+a[u+1],p[t]+=a[u+1],u+=2,s+=2):(e+=a[u],p[t]+=a[u],u++,s++);if(u>=l||")"!==a[u])h.push(new g("@"+i+"("+e));else{u++;var c=new f({group_key:i,props:p,raw_props:e,modifiers:[]});for(h.push(c);u<l&&"."===a[u];){u++;let r="",t=0;for(;u<l&&t<=100&&"("!==a[u];){if("@"===a[u]){h.push(new g("."+r));continue t}r+=a[u],t++,u++}if(u>=l||"("!==a[u]||!/^[a-zA-Z0-9_]+$/.test(r))h.push(new g("."+r));else{let t=0;var d=[];d[0]={content:"",dynamic:!1,raw:""};let e="",s=(u++,1);for(;u<l&&0<s;)if("("===a[u])s++,e+=a[u],d[t].raw+=a[u],d[t].dynamic=!0,d[t].content+="(",u++;else if(")"===a[u]){if(0===--s)break;e+=a[u],d[t].raw+=a[u],d[t].content+=")",u++}else if(","===a[u]&&1===s)e+=a[u],d[++t]={content:"",dynamic:!1,raw:""},u++;else if("\\"===a[u]&&n[a[u+1]||""]){if(")"===a[u+1]&&d[t].content.endsWith("@value(")&&0===--s)break;1===s?(e+=a[u]+a[u+1],d[t].raw+=a[u]+a[u+1],d[t].content+=a[u+1],u+=2):(e+=a[u],d[t].raw+=a[u],d[t].content+=a[u],u++)}else e+=a[u],d[t].raw+=a[u],d[t].content+=a[u],u++;0!==s?h.push(new g("."+r+"("+e)):(u++,c.addModifier({key:r,args:d,raw_args:e}))}}}}}else{let t="";for(;u<l&&"@"!==a[u];)t+=a[u],u++;""!==t&&h.push(new g(t))}return h},getTokenAtOffset:function(t,e,s=!0){let r=0;for(var i of t){var o;if(e<=(r+=i.getLength()))return o=e-(r-i.getLength()),i.subOffset=o,"dynamic-tag"===i.getType()&&s?i.getTokenAtOffset(o,!1):i}return null},getTokenAtOffsetDeep:function(t,e){let s=0;for(var r of t){var i;if(e<=(s+=r.getLength()))return i=e-(s-r.getLength()),r.subOffset=i,"dynamic-tag"===r.getType()?r.getTokenAtOffset(i):r}return null}},a={template:"#vx-dynamic-code-editor",props:{modelValue:{type:String,default:""},layout:{type:String,default:"full"},placeholder:{type:String,default:"Press @ to quickly add a tag, or pick one from the left sidebar"},tagAutocompleteContext:{type:String,default:null}},data(){return{content:"string"==typeof this.modelValue?this.modelValue:"",dropdown:{show:!1,style:{top:null,left:null},caretOffset:null,mode:"insertTag",insertTag:{query:{startIndex:null,endIndex:null,content:""},context:null},insertModifier:{query:{startIndex:null,endIndex:null,content:""},tag:null}},resizeObserverBound:!1}},created(){this.updateHistoryDebounced=Voxel_Backend.helpers.debounce(function(t,e,s){s.updateHistory(t,e)},125),(window.VXS_Editor=this).tokenizer=this.$root.tokenizer,this.history={undoStack:[],redoStack:[],isUserInput:!0}},mounted(){this.$nextTick(()=>{document.addEventListener("click",this.handleOutsideClick),this.resizeObserver=new ResizeObserver(()=>this.repositionDropdown()),!this.resizeObserverBound&&this.$refs.dropdown&&(this.resizeObserverBound=!0,this.resizeObserver.observe(this.$refs.dropdown))})},updated(){!this.resizeObserverBound&&this.$refs.dropdown&&this.resizeObserver&&(this.resizeObserverBound=!0,this.resizeObserver.observe(this.$refs.dropdown))},beforeDestroy(){document.removeEventListener("click",this.handleOutsideClick),this.resizeObserver.disconnect()},methods:{onClick(t){var e=this.$refs.editor.selectionStart,s=(this.content.substr(0,e),this.tokenizer.tokenize(this.content)),s=this.tokenizer.getTokenAtOffset(s,e,!1);null===s?this.$emit("token-focus",{token:null}):this.$emit("token-focus",{token:s,startIndex:e-s.subOffset})},onInput(t){var e=this.$refs.editor.selectionStart;if("@"===t.data){var s=this.tokenizer.tokenize(this.content),s=this.tokenizer.getTokenAtOffset(s,e);if(null===s||!["plain-text","modifier"].includes(s.getType()))return;this.dropdown.insertTag.query.startIndex=e,this.dropdown.insertTag.query.endIndex=e,this.dropdown.insertTag.context="modifier"===s.getType()?"modifier":null,this.showDropdown("insertTag",e)}this.dropdown.show&&"insertTag"===this.dropdown.mode&&(e>=this.dropdown.insertTag.query.startIndex&&e-this.dropdown.insertTag.query.startIndex<=64?(this.dropdown.insertTag.query.endIndex=e,s=this.content.substring(this.dropdown.insertTag.query.startIndex,e).trim().toLowerCase(),this.dropdown.insertTag.query.content=s,this.$nextTick(()=>this.$refs.suggestions.focusFirstItem())):this.hideDropdown()),"."===t.data&&(s=this.tokenizer.tokenize(this.content),t=this.tokenizer.getTokenAtOffsetDeep(s,e),s=this.tokenizer.getTokenAtOffsetDeep(s,e-1),"plain-text"===t?.getType())&&["dynamic-tag","modifier"].includes(s?.getType())&&(this.dropdown.insertModifier.query.startIndex=e,this.dropdown.insertModifier.query.endIndex=e,this.dropdown.insertModifier.tag="modifier"===s.getType()?s.parent:s,this.showDropdown("insertModifier",e)),this.dropdown.show&&"insertModifier"===this.dropdown.mode&&(e>=this.dropdown.insertModifier.query.startIndex&&e-this.dropdown.insertModifier.query.startIndex<=64?(this.dropdown.insertModifier.query.endIndex=e,t=this.content.substring(this.dropdown.insertModifier.query.startIndex,e).trim().toLowerCase(),this.dropdown.insertModifier.query.content=t,this.$nextTick(()=>this.$refs.suggestions.focusFirstItem())):this.hideDropdown()),this.$emit("token-focus",{token:null})},onKeydown(e){const s=this.$refs.editor;if(this.dropdown.show&&("ArrowDown"===e.key?(e.preventDefault(),this.$refs.suggestions.focusNextItem()):"ArrowUp"===e.key?(e.preventDefault(),this.$refs.suggestions.focusPrevItem()):"Enter"===e.key?(e.preventDefault(),this.$refs.suggestions.clickFocusedItem()):"Escape"===e.key&&this.hideDropdown()),"Tab"===e.key){e.preventDefault();let t=s.selectionStart;var r=s.selectionEnd;this.content=this.content.substr(0,t)+"\t"+this.content.substr(r),this.$nextTick(()=>{s.selectionStart=s.selectionEnd=t+1,s.focus()})}var r=e.ctrlKey||e.metaKey,t=e.key.toLowerCase(),i=e.code;!r||"z"!==t&&"KeyZ"!==i?!r||"y"!==t&&"KeyY"!==i||(e.preventDefault(),this.redo()):(e.preventDefault(),e.shiftKey?this.redo():this.undo())},onScroll(t){var e=this.$refs.editor,s=this.$refs.highlighter;s.scrollTop=e.scrollTop,s.scrollLeft=e.scrollLeft},onDrop(t){requestAnimationFrame(()=>{var t=this.$refs.editor;t.selectionStart=t.selectionEnd,t.focus()})},dropdownTagSelected(t){var e=t.tag,t=t.result;const s=this.$refs.editor;var r=this.dropdown.insertTag.query.startIndex-1,i=this.dropdown.insertTag.query.endIndex,r=this.content.substr(0,r),i=this.content.substr(i);this.content=r+e+i;let o=(r+e).length;"method"===t.data.type&&t.data.method.arguments.length&&--o,this.hideDropdown(),this.$nextTick(()=>{s.selectionStart=s.selectionEnd=o,s.focus()})},dropdownModSelected(t){const e=this.$refs.editor;var s=`.${t.key}()`,r=this.dropdown.insertModifier.query.startIndex-1,i=this.dropdown.insertModifier.query.endIndex,r=this.content.substr(0,r),i=this.content.substr(i);this.content=r+s+i;let o=(r+s).length;t.arguments.length&&--o,this.hideDropdown(),this.$nextTick(()=>{e.selectionStart=e.selectionEnd=o,e.focus()})},showDropdown(t,e){this.dropdown.mode=t,this.dropdown.caretOffset=e,this.dropdown.show=!0,this.repositionDropdown()},repositionDropdown(){this.dropdown.show&&this.$nextTick(()=>{var t,e,s=this.getCaretPosition(this.dropdown.caretOffset);null!==s&&(e=this.$refs.dropdown.offsetWidth,t=window.innerWidth,s.left+e>t?this.dropdown.style.left=t-e+"px":this.dropdown.style.left=s.left+"px",t=this.$refs.dropdown.offsetHeight,e=window.innerHeight,s.top+t>e&&s.top>=t?this.dropdown.style.top=s.top-t-5+"px":this.dropdown.style.top=s.top+s.height+5+"px")})},getCaretPosition(n){var t=this.$refs.highlighter;let a=0;const l=e=>{for(let t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(s.nodeType===Node.TEXT_NODE){var r,i=s.textContent.length;if(a+i>=n)return r=n-a,r=s.splitText(r),(o=document.createElement("span")).classList.add("hl-caret"),e.insertBefore(o,r),r=o.getBoundingClientRect(),o.remove(),{top:r.top,left:r.left,width:r.width,height:r.height};a+=i}else if(s.nodeType===Node.ELEMENT_NODE&&!s.classList.contains("ts-line-number")){var o=l(s);if(null!==o)return o}}return null};return l(t)},hideDropdown(){this.dropdown.show=!1},handleOutsideClick(t){t.target.closest(".dtags-ac")||this.hideDropdown()},canUndo(){return 0<this.history.undoStack.length},canRedo(){return 0<this.history.redoStack.length},undo(){var t;this.canUndo()&&(t=this.history.undoStack.pop(),this.history.redoStack.push(this.content),this.history.isUserInput=!1,this.content=t,this.$nextTick(()=>this.history.isUserInput=!0))},redo(){var t;this.canRedo()&&(t=this.history.redoStack.pop(),this.history.undoStack.push(this.content),this.history.isUserInput=!1,this.content=t,this.$nextTick(()=>this.history.isUserInput=!0))},updateHistory(t,e){this.history.undoStack.push(e),100<this.history.undoStack.length&&this.history.undoStack.shift(),this.history.redoStack=[]}},computed:{highlightedContent(){var t;let e="";for(t of this.tokenizer.tokenize(this.$root.escapeHTML(this.content)))e+=t.highlighted();"\n"===e.at(-1)&&(e+=" ");var s=e.split("\n");let r="";for(var i=0;i<s.length;i++)r+=`<span class="ts-line"><span class="ts-line-number">${i+1}</span>${s[i]}</span>
`;return r},shouldUseSmallFont(){return 100<this.content.length}},watch:{content(t,e){this.history.isUserInput&&this.updateHistoryDebounced(t,e,this),this.$emit("update:modelValue",this.content)},shouldUseSmallFont(t){this.repositionDropdown()},modelValue(t){this.content="string"==typeof t?t:""}}},l={template:"#vx-dynamic-group-list",props:{search:{type:String,default:""}},emits:["select-tag"],data(){return{activeGroups:{},transitionHeight:!0}},created(){this.groupStore=structuredClone(this.$root.groups),this.activeGroups=this.getGroups()},methods:{getGroups(){if(""===this.search.trim()){const s={};return Object.keys(this.groupStore).forEach(t=>{var e=this.groupStore[t];s[t]={...e,exports:{...e.exports}}}),s}const l=this.search.trim().toLowerCase(),t={};return Object.keys(this.groupStore).forEach(i=>{const o=this.groupStore[i],n={},a=[o.label],s={};Object.keys(o.group.exports).forEach(t=>{var e,s=o.group.exports[t],r=`@${i}(${s.path.join(".")})`;"object"===s.type||"object-list"===s.type?(e=this._searchProperty(s,l,i,[],a),Object.keys(e).length&&(n[t]={...s,exports:e})):s.hidden||-1===r.toLowerCase().indexOf(l)&&-1===a.concat(s.label).join(" ").toLowerCase().indexOf(l)||(n[t]={...s})}),Object.keys(o.group.methods).forEach(t=>{var e=o.group.methods[t];-1===`@${i}().${t}()`.toLowerCase().indexOf(l)&&-1===a.concat(e.label).join(" ").toLowerCase().indexOf(l)||(s[t]={...e})}),(Object.keys(n).length||Object.keys(s).length)&&(t[i]={label:o.label,group:{...o.group,exports:n,methods:s}})}),this.$nextTick(()=>{let e=t=>{t&&(t.click(),this.$nextTick(()=>{e(t.parentElement.querySelector(":scope > ul > li.is-group:first-child > span"))}))};e(this.$refs.wrapper.querySelector(":scope > ul > li.is-group:first-child > span"))}),t},_searchProperty(t,i,o,n=[],a=[]){const l={};a=a.concat(t.label);let h=t.exports;if(t.subgroup){if(n.length)return{};h=this.$root.Dynamic_Data_Store.groups[t.subgroup?.key].exports,n=n.concat(t.path)}return Object.keys(h).forEach(t=>{var e,s=h[t],r=`@${o}(${n.concat(s.path).join(".")})`;"object"===s.type||"object-list"===s.type?(e=this._searchProperty(s,i,o,n,a),Object.keys(e).length&&(l[t]={...s,exports:e})):s.hidden||-1===r.toLowerCase().indexOf(i)&&-1===a.concat(s.label).join(" ").toLowerCase().indexOf(i)||(l[t]={...s})}),l},toggleGroup(t){var e=!t._open;Object.values(this.activeGroups).forEach(t=>{t._open=!1}),t._open=e},suspendTransitions(t=300){this.transitionHeight=!1,clearTimeout(this.transitionTimeout),this.transitionTimeout=setTimeout(()=>{this.transitionHeight=!0},t)},focusFirstItem(){var t=Array.from(this.$refs.wrapper.querySelectorAll("li > span"));t.length&&(t.forEach((t,e)=>{t.classList.contains("is-active")&&t.classList.remove("is-active")}),t[0].classList.add("is-active"),this._scrollToItem(t[0]))},focusNextItem(){var e=Array.from(this.$refs.wrapper.querySelectorAll("li > span"));if(e.length){let s=-1,t=(e.forEach((t,e)=>{t.classList.contains("is-active")&&(t.classList.remove("is-active"),s=e)}),-1===s?0:s+1);e[t=t>=e.length?e.length-1:t].classList.add("is-active"),this._scrollToItem(e[t])}},focusPrevItem(){var e=Array.from(this.$refs.wrapper.querySelectorAll("li > span"));if(e.length){let s=-1,t=(e.forEach((t,e)=>{t.classList.contains("is-active")&&(t.classList.remove("is-active"),s=e)}),-1===s?e.length-1:s-1);e[t=t<0?0:t].classList.add("is-active"),this._scrollToItem(e[t])}},clickFocusedItem(){var t=this.$refs.wrapper.querySelector("li > span.is-active");t&&(t.click(),this._scrollToItem(t))},_scrollToItem(t){requestAnimationFrame(()=>{t.scrollIntoView({behavior:"instant",block:"nearest",inline:"nearest"})})}},watch:{search(){this.activeGroups=this.getGroups()}}},h={template:"#vx-dynamic-tag-autocomplete",props:{search:{type:String,default:""},context:{type:String,default:""}},emits:["select-tag"],data(){return{focusedResult:-1}},created(){this.dataSet=[...this.$root.getSearchDataSet()],this.results=this.dataSet,"modifier"===this.context&&this.dataSet.unshift({matcher:"Current value",data:{property:this.$root.Dynamic_Data_Store.groups.value.exports[""],meta:{tag:"@value()",parentLabels:["Context"]}}})},methods:{focusFirstItem(){this.results.length&&(this.focusedResult=0,this._scrollToItem(this.$refs.result[this.focusedResult]))},focusNextItem(){var t=this.results.length;t&&this.focusedResult<t-1&&(this.focusedResult+=1,this._scrollToItem(this.$refs.result[this.focusedResult]))},focusPrevItem(){this.results.length&&0<this.focusedResult&&(--this.focusedResult,this._scrollToItem(this.$refs.result[this.focusedResult]))},clickFocusedItem(){this.$refs.result[this.focusedResult]?.click()},_scrollToItem(t){requestAnimationFrame(()=>{t.scrollIntoView({behavior:"instant",block:"nearest",inline:"nearest"})})},selectItem(t){this.$emit("select-tag",{tag:t.data.meta.tag,result:t})}},computed:{searchQuery(){return this.search.trim().toLowerCase()}},watch:{search(){""===this.searchQuery?this.results=this.dataSet:this.results=Voxel_Backend.fuzzyMatch(this.searchQuery,this.dataSet)}}},u={template:"#vx-dynamic-mod-autocomplete",props:{search:{type:String,default:""},token:Object},emits:["select-mod"],data(){return{details:{},focusedResult:-1,results:[]}},created(){this.details=this.$root.getTokenDetails(this.token),this.dataSet=this.getSearchDataSet(),this.results=this.dataSet},methods:{focusFirstItem(){this.totalResultCount&&(this.focusedResult=0,this._scrollToItem(this.$refs.result[this.focusedResult]))},focusNextItem(){this.totalResultCount&&this.focusedResult<this.totalResultCount-1&&(this.focusedResult+=1,this._scrollToItem(this.$refs.result[this.focusedResult]))},focusPrevItem(){this.totalResultCount&&0<this.focusedResult&&(--this.focusedResult,this._scrollToItem(this.$refs.result[this.focusedResult]))},clickFocusedItem(){this.$refs.result[this.focusedResult]?.click()},_scrollToItem(t){requestAnimationFrame(()=>{t.scrollIntoView({behavior:"instant",block:"nearest",inline:"nearest"})})},selectItem(t){this.$emit("select-mod",t.data.modifier)},getSearchDataSet(){const e=[];return Object.values(this.$root.Dynamic_Data_Store.modifiers).forEach(t=>{e.push({data:{modifier:t},matcher:t.label})}),this.details.group&&Object.values(this.details.group.group.methods).forEach(t=>{e.push({data:{modifier:t},matcher:t.label})}),e}},computed:{searchQuery(){return this.search.trim().toLowerCase()},categorizedResults(){const r=this.details["ancestors"],i=(r.at(-1),{string:{label:"Text",items:[]},number:{label:"Number",items:[]},date:{label:"Date",items:[]},other:{label:"Other",items:[]},conditionals:{label:"Conditionals",items:[]}}),e=(this.results.forEach(t=>{var e=t.data.modifier;let s=e.expects[0];i[s]||(s="other"),"control-structure"===e.type&&(s="conditionals"),"method"===e.type&&(s="other"),["list","count"].includes(e.key)&&!r.some(t=>"object-list"===t.type)||i[s].items.push(t)}),[]);let s=0;return Object.keys(i).forEach(t=>{t=i[t];t.items.length&&(t.items.forEach(t=>t.resultIndex=s++),e.push(t))}),e},totalResultCount(){let e=0;return this.categorizedResults.forEach(t=>e+=t.items.length),e}},watch:{search(){this.results=Voxel_Backend.fuzzyMatch(this.searchQuery,this.dataSet)}}},p={template:"#vx-dynamic-property-list",props:{group:Object,groupKey:String,groupList:Object,properties:Object,prependPath:{type:Array,default:[]},methods:Object},data(){return{activeProperties:{}}},created(){this.activeProperties=this.properties},methods:{getFullPath(t){let e=[];return e=(e=e.concat(this.prependPath)).concat(t.path)},getTagScript(t){return`@${this.groupKey}(${this.getFullPath(t).join(".")})`},getMethodScript(t){return`@${this.groupKey}().${t.key}()`},selectItem(t){t=this.getTagScript(t);this.groupList.$emit("select-tag",t)},selectMethod(t){t=this.getMethodScript(t);this.groupList.$emit("select-tag",t)},onDragStart(t,e){e=this.getTagScript(e);t.dataTransfer.clearData(),t.dataTransfer.setData("text/plain",e)},onMethodDragStart(t,e){e=this.getMethodScript(e);t.dataTransfer.clearData(),t.dataTransfer.setData("text/plain",e)},getNestedProperties(t){return t.subgroup&&!t.exports?{...this.$root.Dynamic_Data_Store.groups[t.subgroup?.key].exports}:{...t.exports}},getNestedPrependPath(t){return t.subgroup?this.prependPath.concat(t.path):this.prependPath},toggleSubgroup(t){var e=!t._open;Object.values(this.properties).forEach(t=>{!0===t._open&&(t._open=!1)}),t._open=e}}},c={template:"#vx-dynamic-loopable-property-list",props:{properties:Object,container:Object,path:Array,groupKey:String},emits:["select"],data(){return{activeProperty:null}},methods:{useLoopItem(t,e){e=`@${this.groupKey}(${this.path.concat(e).join(".")})`;this.$emit("select",{tag:e})},isSelected(t,e){e=`@${this.groupKey}(${this.path.concat(e).join(".")})`;return this.container.selected===e}}},d={props:{active:{type:Boolean,default:!0}},template:`
		<template v-if="active">
			<transition name="expand" @after-enter="afterEnter" @enter="enter" @leave="leave">
				<slot></slot>
			</transition>
		</template>
		<template v-else>
			<slot></slot>
		</template>
	`,methods:{afterEnter(t){t.style.height="auto"},enter(t){const e=getComputedStyle(t)["height"];t.style.height=0,requestAnimationFrame(()=>{t.style.height=e})},leave(t){var e=getComputedStyle(t)["height"];t.style.height=e,requestAnimationFrame(()=>{t.style.height=0})}}};const m="\\";wp.domReady(()=>{const e=document.createElement("textarea");var t=Vue.createApp({data(){return{visible:!1,mode:"edit-content",state:{editContent:{content:""},editVisibility:{rules:[]},editLoop:{selected:null}}}},created(){(window.Voxel_Dynamic=this).tokenizer=n,this.Dynamic_Data_Store=Dynamic_Data_Store,this.window=window},methods:{escapeHTML(t){return e.textContent=t,e.innerHTML},isDynamicString(t){return(""+t).includes("@tags()")},getDynamicString(t){return(""+t).replace("@tags()","").replace("@endtags()","")},formatForEditorPreview(t){return t},formatAsHTML(t){var e;let s="";for(e of this.tokenizer.tokenize(this.escapeHTML(t)))s+=e.highlighted();return s},getDefaultGroups(){return{user:{label:"User",type:"user"},post:{label:"Post",type:"simple-post"},author:{label:"Author",type:"user"},site:{label:"Site",type:"site"},term:{label:"Term",type:"term"}}},edit(t,e={}){let s={},r=(Object.keys(e.groups).forEach(t=>{s[t]={label:e.groups[t].label,group:Dynamic_Data_Store.groups[e.groups[t].type]}}),this.mode="edit-content",this.state.editContent.content=t,this.groups=s,this.visible=!0,()=>{e.onSave(this.state.editContent.content),this.groups=null,this.emitter.off("save",r),this.emitter.off("discard",i)}),i=()=>{this.groups=null,this.emitter.off("save",r),this.emitter.off("discard",i)};this.emitter.on("save",r),this.emitter.on("discard",i),this.$nextTick(()=>this.$refs.editContent?.focusEditor())},getSearchDataSet(){if(this.searchDataSet)return this.searchDataSet;const n=[],a=(t,s,r=[],i=[])=>{i=i.concat(t.label);let o=t.exports;if(t.subgroup){if(r.length)return;o=this.$root.Dynamic_Data_Store.groups[t.subgroup.key].exports,r=r.concat(t.path)}return Object.keys(o).forEach(t=>{var t=o[t],e=`@${s}(${r.concat(t.path).join(".")})`;"object"===t.type||"object-list"===t.type?a(t,s,r,i):t.hidden||n.push({data:{property:t,meta:{parentLabels:i,tag:e}},matcher:i.concat(t.label).join(" ")})}),this.searchDataSet=n,this.searchDataSet};return Object.keys(this.$root.groups).forEach(s=>{const r=this.$root.groups[s],i=[r.label];Object.keys(r.group.exports).forEach(t=>{var t=r.group.exports[t],e=`@${s}(${t.path.join(".")})`;"object"===t.type||"object-list"===t.type?a(t,s,[],i):t.hidden||n.push({data:{property:t,meta:{parentLabels:i,tag:e}},matcher:i.concat(t.label).join(" ")})}),Object.keys(r.group.methods).forEach(t=>{var e=r.group.methods[t],t=`@${s}().${t}()`;n.push({data:{type:"method",method:e,meta:{parentLabels:i,tag:t}},matcher:i.concat(e.label).join(" ")})})}),n},getTokenDetails(i){var o={token:i,group:null,ancestors:[],property:null},t=this.groups[i.group_key];if(t){let s=(o.group=t).group.exports,r=t.group.aliases;for(let e=0;e<i.props.length;e++){let t=i.props[e];var n=e===i.props.length-1;if(r[t]&&(t=r[t]),!s[t])break;var a=s[t];if(n)o.property=a;else{if("object"!==a.type&&"object-list"!==a.type)break;o.ancestors.push(a),r=(a.subgroup?(n=this.Dynamic_Data_Store.groups[a.subgroup.key],s=n.exports,n):(s=a.exports,a)).aliases}}}return o},editVisibility(r,i={}){let e={};Object.keys(i.groups).forEach(t=>{e[t]={label:i.groups[t].label,group:Dynamic_Data_Store.groups[i.groups[t].type]}}),this.groups=e,this.mode="edit-visibility",this.visible=!0,this.$nextTick(()=>{let t=[[{type:null}]],e=(Array.isArray(r)&&r.length&&(t=JSON.parse(JSON.stringify(r))),this.$refs.editVisibility.setRules(t),t=>{i.onSave(t),this.emitter.off("save",e),this.emitter.off("discard",s)}),s=()=>{"function"==typeof i.onDiscard&&i.onDiscard(),this.emitter.off("save",e),this.emitter.off("discard",s)};this.emitter.on("save",e),this.emitter.on("discard",s)})},editLoop(e={}){let s={};Object.keys(e.groups).forEach(t=>{s[t]={label:e.groups[t].label,group:Dynamic_Data_Store.groups[e.groups[t].type]}}),this.groups=s,this.mode="edit-loop",this.visible=!0;var t="string"==typeof e.currentValue?e.currentValue:null;this.state.editLoop.selected=t;let r=()=>{e.onSave(this.state.editLoop.selected),this.emitter.off("save",r),this.emitter.off("discard",i)},i=()=>{"function"==typeof e.onDiscard&&e.onDiscard(),this.emitter.off("save",r),this.emitter.off("discard",i)};this.emitter.on("save",r),this.emitter.on("discard",i)},formatRulesAsHTML(t){Array.isArray(t)||(t=[]);let e=[];return t.forEach(t=>{Array.isArray(t)||(t=[]);let r=[];t.forEach(s=>{var t=Dynamic_Data_Store.visibility_rules[s?.type];if(t){let e=[];if("dtag"===s.type){if(!(s.tag&&s.compare&&Dynamic_Data_Store.modifiers[s.compare]))return;e.push(this.unescapeModifierArgument(s.tag)),e.push(Dynamic_Data_Store.modifiers[s.compare].label),s.arguments&&Object.values(s.arguments).filter(Boolean).length&&e.push(Object.values(s.arguments).map(t=>this.unescapeModifierArgument(t)).filter(Boolean).join(", "))}else e.push(Dynamic_Data_Store.visibility_rules[s.type].label),Object.keys(t.arguments).forEach(t=>{s[t]&&e.push(s[t])});r.push("<p>"+e.join(" ")+"</p>")}}),r.length&&e.push('<div class="rule-group">'+r.join("")+"</div>")}),e.length?e.join('<p class="rule-divider">or</p>'):`<span class="elementor-control-field-description">
							No visibility rules added.
						</span>`},escapeModifierArgument(t){if("string"!=typeof t)return t;var e,s=[],r=[];for(e of this.tokenizer.tokenize(t))if("dynamic-tag"===e.getType()){var i=e.toScript();for(let t=0;t<i.length;t++){var o=i[t];s.push(o)}}else if("plain-text"===e.getType()){var n=e.getText();for(let t=0;t<n.length;t++){var a=n[t];a===m?s.push(m.repeat(2)):","===a?s.push("\\,"):"("===a?(r.push(s.length),s.push("(")):")"===a?0<r.length?(r.pop(),s.push(")")):s.push("\\)"):s.push(a)}}for(;0<r.length;)s[r.pop()]="\\(";return s.join("")},unescapeModifierArgument(t){if("string"!=typeof t)return t;var e=this.tokenizer.tokenize(t);let s="",r=0;for(;r<e.length;){var i=e[r];if("dynamic-tag"===i.getType())s+=i.toScript(),r++;else if("plain-text"===i.getType()){let t=i.getText();for(r++;r<e.length;){var o=e[r];if("plain-text"!==o.getType())break;t+=o.getText(),r++}t=t.replaceAll(m.repeat(2),m).replaceAll("\\,",",").replaceAll("\\(","(").replaceAll("\\)",")"),s+=t}else r++}return s}}});t.component("mode-edit-content",s),t.component("mode-edit-visibility",r),t.component("mode-edit-loop",i),t.component("code-editor",a),t.component("group-list",l),t.component("property-list",p),t.component("tag-autocomplete",h),t.component("mod-autocomplete",u),t.component("loopable-property-list",c),t.component("transition-height",d),t.component("draggable",vuedraggable),t.config.globalProperties.emitter=Voxel_Backend.mitt(),t.mount("#vx-dynamic-data"),Array.from(document.querySelectorAll(".nav-item-visibility-rules")).forEach(t=>{Voxel_Backend._nav_display_rules(t)})})});
