!function(e){"function"==typeof define&&define.amd?define("messages",e):e()}(function(){"use strict";var t={template:"#create-post-media-popup",props:{multiple:{type:Boolean,default:!0},ignore:{type:Array,default:[]},customTarget:[Object,String],saveLabel:String},emits:["save","blur","open"],data(){return{files:[],selected:{},active:!1,loading:!0,has_more:!1,firstLoad:!0,search:{term:"",offset:0,loading:!1,loading_more:!1,has_more:!1,list:null}}},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},selectFile(e){this.selected[e.id]?delete this.selected[e.id]:(this.multiple||(this.selected={}),this.selected[e.id]=e)},selectSessionFile(e){this.selected[e._id]?delete this.selected[e._id]:(this.multiple||(this.selected={}),this.selected[e._id]=e)},loadMedia(){jQuery.get(Voxel_Config.ajax_url+"&action=list_media",{offset:this.files.length}).always(e=>{this.loading=!1,e.success?(this.files.push(...e.data),this.has_more=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},loadMore(){this.loading=!0,this.loadMedia()},openLibrary(){this.$emit("open"),this.firstLoad&&this.loadMedia(),this.firstLoad=!1,this.active=!this.active},isImage(e){return e.type.startsWith("image/")},save(){this.active=!1,this.$emit("save",this.selected),this.selected={}},clear(){this.selected={}},clientSearchFiles(){let s=this.search.term.trim().toLowerCase(),t=[],i=!1;this.files.forEach(e=>{i||-1!==e.name.toLowerCase().indexOf(s)&&(t.push(e),i=10<=t.length)}),this.search.list=t,this.search.loading=!1,this.search.has_more=!1,this.search.loading_more=!1},serverSearchFiles:Voxel.helpers.debounce((s,t=!1)=>{jQuery.get(Voxel_Config.ajax_url+"&action=list_media",{offset:t?s.search.list.length:0,search:s.search.term.trim()}).always(e=>{s.search.loading=!1,s.search.loading_more=!1,e.success?(t?s.search.list.push(...e.data):s.search.list=e.data,s.search.has_more=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}),sessionFiles(){return Array.isArray(window._vx_file_upload_cache)||(window._vx_file_upload_cache=[]),window._vx_file_upload_cache.reverse()}},watch:{"search.term"(){this.search.term.trim()&&this.files&&(this.search.loading=!0,!this.has_more||this.search.term.trim().length<=2?this.clientSearchFiles():this.serverSearchFiles(this))}}},i={template:"#create-post-file-field",props:{field:Object,mediaTarget:[Object,String],index:{type:Number,default:null},sortable:{type:Boolean,default:!0},showLibrary:{type:Boolean,default:!0},previewImages:{type:Boolean,default:!0}},data(){return{accepts:"",dragActive:!1,reordering:!1}},created(){null===this.field.value&&(this.field.value=[]),this.field.props.allowedTypes&&(this.accepts=Object.values(this.field.props.allowedTypes).join(", ")),this.$watch(()=>this.field.value,()=>{this.validate(this.field.value)},{deep:!0})},mounted(){jQuery(this.$refs.input).on("change",e=>{for(var s=0;s<e.target.files.length;s++){var t=e.target.files[s];this.pushFile(t)}this.$refs.input.value="",this.$emit("files-added")})},unmounted(){setTimeout(()=>{Object.values(this.field.value).forEach(e=>{"new_upload"===e.source&&URL.revokeObjectURL(e.preview)})},10)},methods:{getStyle(e){return e.type.startsWith("image/")&&this.previewImages?`background-image: url('${e.preview}');`:""},pushFile(s){1===this.field.props.maxCount&&(this.field.value=[]);var e={source:"new_upload",name:s.name,type:s.type,size:s.size,preview:URL.createObjectURL(s),item:s,_id:Voxel.helpers.randomId(8)},t=(void 0===window._vx_file_upload_cache&&(window._vx_file_upload_cache=[]),window._vx_file_upload_cache.find(e=>e.item.name===s.name&&e.item.type===s.type&&e.item.size===s.size&&e.item.lastModified===s.lastModified));t?this.field.value.push(t):(this.field.value.push(e),window._vx_file_upload_cache.unshift(e))},onDrop(e){this.dragActive=!1,e.dataTransfer.items?[...e.dataTransfer.items].forEach(e=>{"file"===e.kind&&this.pushFile(e.getAsFile())}):[...e.dataTransfer.files].forEach(e=>{this.pushFile(e)}),this.$emit("files-added")},onMediaPopupSave(e){1===this.field.props.maxCount&&(this.field.value=[]);var s={};this.field.value.forEach(e=>{"existing"===e.source&&(s[e.id]=!0),"new_upload"===e.source&&(s[e._id]=!0)}),Object.values(e).forEach(e=>{"existing"!==e.source||s[e.id]||this.field.value.push(e),"new_upload"!==e.source||s[e._id]||this.field.value.push(e)}),this.$emit("files-added")},onSubmit(s,t,e=null){var i;i=null!==e?`files[${this.field.id}::row-${e}][]`:`files[${this.field.id}][]`,s[this.field.key]=[],this.field.value.forEach(e=>{"new_upload"===e.source?(t.append(i,e.item),s[this.field.key].push("uploaded_file")):"existing"===e.source&&s[this.field.key].push(e.id)})},validate(e){if(this.$root.shouldValidate()){let s=[];var a=!(Array.isArray(e)&&1<=e.length),o=this.field.props.maxCount;let t=this.field.props.maxSize,i=this.field.props.allowedTypes;this.$root.shouldValidateRequired()&&this.field.required&&a&&s.push(this.$root.get_error("required")),a||(o&&e.length>o&&s.push(this.$root.replace_vars(this.$root.get_error("file:max"),{"@max":o})),t&&e.forEach(e=>{"new_upload"===e.source&&e.size>1e3*t&&s.push(this.$root.replace_vars(this.$root.get_error("file:size"),{"@filename":e.name,"@limit_kb":t,"@limit_mb":t/1e3}))}),Array.isArray(i)&&i.length&&e.forEach(e=>{i.includes(e.type)||s.push(this.$root.replace_vars(this.$root.get_error("file:type"),{"@filename":e.name,"@filetype":e.type}))})),this.field.validation.errors=s}}}};window.render_messages=()=>{Array.from(document.querySelectorAll(".ts-inbox")).forEach(e=>{if(!e.__vue_app__){let r=JSON.parse(e.dataset.config);var s=Vue.createApp({el:e,template:e.innerHTML,mixins:[Voxel.mixins.base],data(){return{widget:"messages",config:r,screen:"main",chats:{list:null,hasMore:!1,loading:!0,loadingMore:!1,page:1},search:{term:"",list:[],loading:!1},activeChat:null,files:{label:"Attach images",key:"files",id:"files",value:[],props:{allowedTypes:r.files.allowed_file_types,maxCount:r.files.max_count}},activePopup:null,emojis:{loading:!0,list:null,recents:[],search:{term:"",list:[]}}}},created(){null===(window.DMs=this).chats.list&&(this.chats.list=[],this.getChats(!0)),setTimeout(()=>this.loadEmojis()),r.polling.enabled&&setTimeout(()=>this.checkActivity(),r.polling.frequency)},methods:{getChats(t=!1){this.chats.loadingMore=!0,jQuery.get(Voxel_Config.ajax_url+"&action=inbox.list_chats",{pg:this.chats.page,load:t?Voxel.getSearchParam("chat"):null,_wpnonce:r.nonce}).always(e=>{var s;e.success?(this.chats.list.push(...e.list),this.chats.hasMore=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.chats.loading=!1,this.chats.loadingMore=!1,t&&((s=this.chats.list.find(e=>e.autoload))?this.openChat(s):e.default_chat&&this.openChat(e.default_chat))})},loadMoreChats(){this.chats.page++,this.getChats()},updateScroll(){this.$refs.body.scrollTop=this.$refs.body.scrollHeight},openChat(e){this.activeChat=e,Voxel.setSearchParam("chat",["post"===e.author.type?e.author.id:"","post"===e.target.type?"p":"u",e.target.id].join("")),null===e.messages.list?(e.messages.list=[],this.loadMessages(e,{cb:()=>{e.is_new=!1,e.seen=!0,this.$nextTick(()=>this.updateScroll())}})):(e.is_new=!1,e.seen=!0,this.$nextTick(()=>this.updateScroll())),this.$nextTick(()=>this.resizeComposer()),this.$nextTick(()=>this.$refs.composer?.focus());var s=Voxel.getSearchParam("text");"string"==typeof s&&s.length&&(this.activeChat.state.content=s),Voxel.deleteSearchParam("text")},closeActiveChat(){this.activeChat=null,Voxel.deleteSearchParam("chat")},loadMessages(s,t={}){s.messages.loadingMore=!0,jQuery.get(Voxel_Config.ajax_url+"&action=inbox.load_chat",{cursor:s.messages.list[s.messages.list.length-1]?.id,author_type:s.author.type,author_id:s.author.id,target_type:s.target.type,target_id:s.target.id,_wpnonce:r.nonce}).always(e=>{e.success?(s.messages.list.push(...e.list),s.messages.hasMore=e.has_more,s.messages.loading=!1,s.messages.loadingMore=!1,s.follow_status.author=e.follow_status.author,s.follow_status.target=e.follow_status.target,t.cb&&t.cb()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},loadMoreMessages(e){let s=this.$refs.body,t=s.scrollHeight-s.scrollTop;this.loadMessages(e,{cb:()=>this.$nextTick(()=>s.scrollTop=s.scrollHeight-t)})},sendMessage(i){let a=i.state.content.trim(),o={id:0,sent_by:"author",time:"now",seen:!1,has_content:a.length,content:"<p>"+a.replace(/(?:\r\n|\r|\n){2,}/g,"</p><p>").replace(/(?:\r\n|\r|\n)/g,"<br>")+"</p>",sending:!0,tmp:!0};var e=new FormData,s={content:a};this.$refs.files.onSubmit(s,e),e.append("fields",JSON.stringify(s)),(s.content.length||s.files.length)&&(s=jQuery.param({sender_type:i.author.type,sender_id:i.author.id,receiver_type:i.target.type,receiver_id:i.target.id,_wpnonce:r.nonce}),jQuery.post({url:Voxel_Config.ajax_url+"&action=inbox.send_message&"+s,data:e,contentType:!1,processData:!1}).always(e=>{var s,t=i.messages.list.indexOf(o);e.success?(i.messages.list[t]=e.message,this.$nextTick(()=>this.updateScroll()),i.excerpt=e.message.excerpt,i.time=e.message.chat_time,-1!==(s=this.chats.list.findIndex(e=>e.key===i.key))&&this.chats.list.splice(s,1),this.chats.list.unshift(i),delete window._vx_file_upload_cache):(Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),i.messages.list.splice(t,1),"validation"===e.error_type&&(i.state.content=a,this.$nextTick(()=>this.resizeComposer())))}),i.messages.list.unshift(o),i.state.content="",this.files.value=[],this.$nextTick(()=>{this.updateScroll(),this.resizeComposer(),this.$refs.composer?.focus()}))},resizeComposer(){this.$refs.composer&&(this.$refs._composer.value=this.$refs.composer.value,this.$refs._composer.style.width=this.$refs.composer.scrollWidth+"px",this.$refs._composer.style.minWidth=this.$refs.composer.scrollWidth+"px",this.$refs._composer.style.maxWidth=this.$refs.composer.scrollWidth+"px",this.$refs.composer.style.height=this.$refs._composer.scrollHeight+"px")},enterComposer(e,s){e.isComposing||229===e.keyCode||e.shiftKey||(e.preventDefault(),this.sendMessage(s))},checkActivity(){var e;"visible"===document.visibilityState?(e=Math.round(Date.now()/1e3),jQuery.get(r.polling.url,{u:r.user.id,v:e}).always(e=>{"1"===e?this.refreshInbox():setTimeout(()=>this.checkActivity(),r.polling.frequency)})):setTimeout(()=>this.checkActivity(),r.polling.frequency)},patchChat(t,e){if(t.excerpt=e.excerpt,t.is_new=e.is_new,t.seen=e.seen,t.time=e.time,null!==e.messages.list&&null!==t.messages.list){e.messages.list.forEach(s=>{var e=t.messages.list.find(e=>e.id===s.id);e&&(e.seen=s.seen,e.is_deleted=s.is_deleted,e.is_hidden=s.is_hidden)});let s=t.messages.list[0]?.id||0;var i=e.messages.list.filter(e=>e.id>s);i.length<15?t.messages.list.unshift(...i):t.messages.list=e.messages.list,t.messages.hasMore=e.messages.hasMore,t.messages.loading=e.messages.loading,t.messages.loadingMore=e.messages.loadingMore}else null!==t.messages.list&&t.last_id===e.last_id||(t.messages.list=e.messages.list,t.messages.hasMore=e.messages.hasMore,t.messages.loading=e.messages.loading,t.messages.loadingMore=e.messages.loadingMore);t.last_id=e.last_id},refreshInbox(){jQuery.get(Voxel_Config.ajax_url+"&action=inbox.list_chats",{pg:1,load:Voxel.getSearchParam("chat"),_wpnonce:r.nonce}).always(e=>{if(e.success){let i=[],a=null;e.list.forEach(s=>{var e,t=this.chats.list.findIndex(e=>e.key===s.key);-1!==t?(e=this.chats.list[t],this.patchChat(e,s),i.push(e),this.chats.list.splice(t,1),s.autoload&&(a=e)):(i.push(s),s.autoload&&(a=s))}),this.chats.list.unshift(...i),a?this.openChat(a):e.default_chat}r.polling.enabled&&setTimeout(()=>this.checkActivity(),r.polling.frequency)})},blockChat(s){var e;confirm(Voxel_Config.l10n.confirmAction)&&(e=jQuery.param({sender_type:s.author.type,sender_id:s.author.id,receiver_type:s.target.type,receiver_id:s.target.id,unblock:-1===s.follow_status.author?"yes":null,_wpnonce:r.nonce}),s.processing=!0,this.$refs.chatActions.blur(),jQuery.post(Voxel_Config.ajax_url+"&action=inbox.block_chat&"+e).always(e=>{s.processing=null,e.success?(s.follow_status.author=e.status,this.$nextTick(()=>this.updateScroll())):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}))},isChatBlocked(e){return-1===e.follow_status.author||-1===e.follow_status.target},clearChat(t,i=!1){var e;confirm(Voxel_Config.l10n.confirmAction)&&(e=jQuery.param({sender_type:t.author.type,sender_id:t.author.id,receiver_type:t.target.type,receiver_id:t.target.id,_wpnonce:r.nonce}),t.processing=!0,this.$refs.chatActions.blur(),jQuery.post(Voxel_Config.ajax_url+"&action=inbox.clear_conversation&"+e).always(e=>{var s;t.processing=null,e.success?(t.messages.list=[],t.messages.hasMore=!1,-1!==(s=this.chats.list.findIndex(e=>e.key===t.key))&&this.chats.list.splice(s,1),i&&this.closeActiveChat()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}))},showEmojis(){this.activePopup="emojiPopup"},loadEmojis(){null===this.emojis.list&&jQuery.get(r.emojis.url).always(e=>{"object"!=typeof e?this.emojis.loading=!1:(this.emojis.loading=!1,this.emojis.list=e)});var e=localStorage.getItem("voxel:recent_emojis");"string"==typeof e&&(this.emojis.recents=[...e])},insertEmoji(s){let t=this.$refs.composer,i=this.activeChat.state.content;if(t.selectionStart||"0"==t.selectionStart){let e=t.selectionStart;var a=t.selectionEnd;i=i.substring(0,e)+s+i.substring(a,t.value.length),setTimeout(()=>t.setSelectionRange(e+s.length,e+s.length))}else i+=s;this.activeChat.state.content=i;let e=[];a=localStorage.getItem("voxel:recent_emojis");(e=(e="string"==typeof a?[...a]:e).filter(e=>e!==s)).unshift(s),localStorage.setItem("voxel:recent_emojis",e.slice(0,16).join("")),this.emojis.recents=e.slice(0,16)},searchEmojis(){let s=[],t=!1;Object.values(this.emojis.list).forEach(e=>{t||e.forEach(e=>{t||-1!==e.name.toLowerCase().indexOf(this.emojis.search.term.trim().toLowerCase())&&(s.push(e.emoji),t=80<=s.length)})}),this.emojis.search.list=s},deleteMessage(s){var e;confirm(Voxel_Config.l10n.confirmAction)&&(e=jQuery.param({deleter_type:this.activeChat.author.type,deleter_id:this.activeChat.author.id,message_id:s.id,_wpnonce:r.nonce}),s.processing=!0,jQuery.post(Voxel_Config.ajax_url+"&action=inbox.delete_message&"+e).always(e=>{s.processing=null,e.success?(s.is_deleted=e.is_deleted,s.is_hidden=e.is_hidden):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}))},clientSearchChats(){let s=this.search.term.trim().toLowerCase(),t=[],i=!1;this.chats.list.forEach(e=>{i||-1!==e.target.name.toLowerCase().indexOf(s)&&(t.push(e),i=10<=t.length)}),this.search.list=t,this.search.loading=!1},serverSearchChats:Voxel.helpers.debounce(s=>{jQuery.get(Voxel_Config.ajax_url+"&action=inbox.search_chats",{search:s.search.term.trim(),_wpnonce:r.nonce}).always(e=>{s.search.loading=!1,e.success?s.search.list=e.list:Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}),shouldValidate(e){return!1}},watch:{"emojis.search.term"(){this.emojis.search.term.trim()&&this.emojis.list&&this.searchEmojis()},"search.term"(){this.search.term.trim()&&this.chats.list&&(this.search.loading=!0,!this.chats.hasMore||this.search.term.trim().length<=2?this.clientSearchChats():this.serverSearchChats(this))}}});s.component("form-popup",Voxel.components.popup),s.component("form-group",Voxel.components.formGroup),i.template="#inbox-file-field",s.component("media-popup",t),s.component("field-file",i),s.mount(e)}})},window.render_messages(),jQuery(document).on("voxel:markup-update",window.render_messages)});
