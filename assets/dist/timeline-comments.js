var Emoji_Picker={template:"#vxfeed__emoji-picker",emits:["select"],props:{composer:Object},data(){return{isOpen:!1,loading:!0,list:null,recents:[],search:{term:"",list:[]}}},methods:{open(){this.isOpen=!0,this.load()},load(){null===this.list&&jQuery.get(this.$root.config.settings.emojis.url).always(e=>{"object"!=typeof e?this.loading=!1:(this.loading=!1,this.list=e)});var e=localStorage.getItem("voxel:recent_emojis");"string"==typeof e&&(this.recents=[...e])},insert(t){this.$emit("select",t);let e=[];var s=localStorage.getItem("voxel:recent_emojis");(e=(e="string"==typeof s?[...s]:e).filter(e=>e!==t)).unshift(t),localStorage.setItem("voxel:recent_emojis",e.slice(0,16).join("")),this.recents=e.slice(0,16)},runSearch(){let t=[],s=!1;Object.values(this.list).forEach(e=>{s||e.forEach(e=>{s||-1!==e.name.toLowerCase().indexOf(this.search.term.trim().toLowerCase())&&(t.push(e.emoji),s=80<=t.length)})}),this.search.list=t}},watch:{"search.term"(){this.search.term.trim()&&this.list&&this.runSearch()}}},Composer_Mixin={components:{"emoji-picker":Emoji_Picker},data(){return{uniqueId:"vxfeed__composer-"+Voxel.helpers.sequentialId(),isFocused:!1,footerHeight:"",data:{content:"",files:[]},mentions:{show:!1,style:{top:null,left:null},caretOffset:null,query:{startIndex:null,endIndex:null,content:""},list:[],focused:0,lastRequest:null},refreshKey:0,isComposing:!1}},created(){this.queryMentions=Voxel.helpers.debounce(()=>{this.mentions.lastRequest?.abort();const t=this.mentions.query.content;this.mentions.lastRequest=jQuery.get(Voxel_Config.ajax_url+"&action=timeline/v2/mentions.search",{search:t,_wpnonce:this.$root.config.nonce}).always(e=>{e.success&&(this.mentions.list=e.users,this.mentions.focused=0,window._vx_mentions_cache[t]=e.users)})},200)},methods:{onInput(e){var t=this.$refs.textarea.selectionStart;"@"!==e.data||1!==t&&!/\s/.test(this.data.content[t-2])||(this.mentions.query.startIndex=t,this.mentions.query.endIndex=t,this.showMentions(t)),this.mentions.show&&(!(t>=this.mentions.query.startIndex&&t-this.mentions.query.startIndex<=32)||(this.mentions.query.endIndex=t,(e=this.data.content.substring(this.mentions.query.startIndex,t)).length&&!/^@[A-Za-z0-9._路@-]{1,63}$/g.test("@"+e))?this.hideMentions():2<=(this.mentions.query.content=e).length&&(Array.isArray(window._vx_mentions_cache[e])?(this.mentions.list=window._vx_mentions_cache[e],this.mentions.focused=0):this.queryMentions()))},onCompositionStart(){this.isComposing=!0},onCompositionUpdate(){requestAnimationFrame(()=>this.refreshKey++)},onCompositionEnd(){this.isComposing=!1},onScroll(e){var t=this.$refs.textarea,s=this.$refs.highlighter;s.scrollTop=t.scrollTop,s.scrollLeft=t.scrollLeft},showMentions(e){this.mentions.caretOffset=e,this.mentions.show=!0,this.mentions.list=[],this.repositionDropdown(),window.addEventListener("resize",()=>this.hideMentions(),{once:!0})},repositionDropdown(){this.mentions.show&&this.$nextTick(()=>{var e,t,s=this.getCaretPosition(this.mentions.caretOffset);null!==s&&(this.mentions.style.top=s.top+s.height+5+"px",e=this.$refs.mentions.offsetWidth,t=window.innerWidth,s.left+e>t?this.mentions.style.left=t-e+"px":this.mentions.style.left=s.left+"px")})},getCaretPosition(r){var e=this.$refs.highlighter;let a=0;const l=t=>{for(let e=0;e<t.childNodes.length;e++){var s=t.childNodes[e];if(s.nodeType===Node.TEXT_NODE){var i,n=s.textContent.length;if(a+n>=r)return i=r-a,i=s.splitText(i),(o=document.createElement("span")).classList.add("hl-caret"),t.insertBefore(o,i),i=o.getBoundingClientRect(),o.remove(),{top:window.pageYOffset+i.top,left:window.pageXOffset+i.left,width:i.width,height:i.height};a+=n}else if(s.nodeType===Node.ELEMENT_NODE){var o=l(s);if(null!==o)return o}}return null};return l(e)},hideMentions(){this.mentions.show=!1},onKeydown(e){this.$refs.textarea,this.mentions.show&&("ArrowDown"===e.key?(e.preventDefault(),this.mentions.focused=Math.min(this.mentions.focused+1,this.mentions.list.length-1)):"ArrowUp"===e.key?(e.preventDefault(),this.mentions.focused=Math.max(this.mentions.focused-1,0)):"Enter"===e.key?(e.preventDefault(),this.$refs.mentions.querySelector("a.is-active")?.click()):"Escape"===e.key&&this.hideMentions()),"Tab"===e.key&&(e.preventDefault(),this.insertText("\t"))},selectMention(e){var{startIndex:t,endIndex:s}=this.mentions.query,i=this.$refs.textarea;i.focus(),i.setSelectionRange(t,s),document.execCommand("insertText",!1,e.username.replaceAll(" ","路")),this.hideMentions()},insertText(e){document.activeElement!==this.$refs.textarea&&this.$refs.textarea.focus(),document.execCommand("insertText",!1,e)},focus(){var e=this.$refs.textarea;e&&e.focus()}},computed:{highlightedContent(){this.refreshKey;let t=this.data.content;this.isComposing&&this.$refs.textarea&&(t=this.$refs.textarea.value),t=this.$root.escapeHTML(t);const s=[],i=e=>{var t=` {${Voxel.helpers.randomId(32)}} `;return s.push({id:t,content:e}),t};return t=(t=(t=(t=(t=t.replace(this.$root.RG_CODE_BLOCK,e=>i(e))).replace(this.$root.RG_INLINE_CODE,e=>i(e))).replace(this.$root.RG_USERNAME,(e,t,s)=>(s=s.replaceAll("路",'<span style="opacity:.3;">路</span>'),i(t+`<a href="#">${s}</a>`)))).replace(this.$root.RG_HASHTAG,(e,t,s)=>i(t+`<a href="#">${s}</a>`))).replace(this.$root.RG_REGULAR_LINK,t=>{try{new URL(t);return`<a href="#">${t}</a>`}catch(e){return t}}),s.forEach(e=>{t=t.replace(e.id,e.content)}),"\n"===t.at(-1)&&(t+=" "),t}}},Comment_Composer={template:"#vxfeed__comment-composer",mixins:[Composer_Mixin],emits:["publish","update","cancel"],props:{status:Object,comment:{type:Object,default:null},replyTo:{type:Object,default:null}},data(){return{submitting:!1,data:{content:"",files:[]},isDragOver:!1}},created(){this.settings=this.$root.config.settings.replies,null!==this.comment&&(this.data.content=this.comment.content,this.data.files=structuredClone(Vue.toRaw(this.comment.files)))},methods:{onCancel(){this.comment?this.comment.content!==this.data.content?Voxel.prompt(this.$root.config.l10n.cancelEdit,"warning",[{label:Voxel_Config.l10n.yes,onClick:()=>this.$emit("cancel")},{label:Voxel_Config.l10n.no,onClick:()=>{}}],7500):this.$emit("cancel"):this.data.content.length||this.data.files.length?Voxel.prompt(this.$root.config.l10n.cancelEdit,"warning",[{label:Voxel_Config.l10n.yes,onClick:()=>this.$emit("cancel")},{label:Voxel_Config.l10n.no,onClick:()=>{}}],7500):this.$emit("cancel")},publish(){if(null!==this.comment){this.submitting=!0;const t=new FormData,s=(this.$root.config,{comment_id:this.comment.id,content:this.data.content,files:[]});this.data.files.forEach(e=>{"new_upload"===e.source?(t.append("files[timeline]",e.item),s.files.push("uploaded_file")):"existing"===e.source&&s.files.push(e.id)}),t.append("data",JSON.stringify(s)),t.append("_wpnonce",this.$root.config.nonce),jQuery.post({url:Voxel_Config.ajax_url+"&action=timeline/v2/comment.edit",data:t,contentType:!1,processData:!1}).always(e=>{this.submitting=!1,e.success?(Voxel.alert(e.message,"success",null,3e3),this.$emit("update",e.comment)):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}else{this.submitting=!0;const i=new FormData,n=(this.$root.config,{status_id:this.status.id,parent_id:this.replyTo?this.replyTo.id:null,content:this.data.content,files:[]});this.data.files.forEach(e=>{"new_upload"===e.source?(i.append("files[timeline]",e.item),n.files.push("uploaded_file")):"existing"===e.source&&n.files.push(e.id)}),i.append("data",JSON.stringify(n)),i.append("_wpnonce",this.$root.config.nonce),jQuery.post({url:Voxel_Config.ajax_url+"&action=timeline/v2/comment.publish",data:i,contentType:!1,processData:!1}).always(e=>{this.submitting=!1,e.success?(this.$emit("publish",e.comment),this.reset()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}},reset(){this.data.content="",this.data.files=[]},onDragEnter(e){e.dataTransfer?.types?.includes("Files")&&this.settings.gallery_enabled&&(this.isDragOver=!0,this.isFocused=!0)},onDrop(e){this.isDragOver=!1,this.$refs.mediaUploader.onDrop(e)}},computed:{avatarUrl(){return this.$root.config.current_user.avatar_url},isExpanded(){return!!this.comment||!!(this.isFocused||this.data.content.length||this.data.files.length)}}},Comment_Feed={template:"#vxfeed__comment-feed",emits:["ready"],props:{status:Object,parentComment:{type:Object,default:null},depth:Number,statusRef:{type:Object,default:null}},data(){return{forceShowComposer:!1}},created(){this.$root.commentFeeds[this.feedKey]?this.feed=this.$root.commentFeeds[this.feedKey]:(this.$root.commentFeeds[this.feedKey]={page:1,loading:!1,hasMore:!1,list:[]},this.feed=this.$root.commentFeeds[this.feedKey],this.parentComment?0<this.parentComment.replies.count&&this.getComments():this.statusRef?.showActiveComment?this.getActiveComment():0<this.status.replies.count&&this.getComments())},mounted(){this.$nextTick(()=>this.$emit("ready"))},methods:{getComments(){this.feed.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline/v2/comments/get_feed",{page:this.feed.page,status_id:this.status.id,parent_id:this.parentComment?.id}).always(e=>{this.feed.loading=!1,e.success?(this.feed.list.push(...e.data),this.feed.hasMore=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},getActiveComment(){this.feed.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline/v2/comments/get_feed",{mode:"single_comment",status_id:this.status.id,reply_id:this.$root.config.single_reply_id}).always(e=>{this.feed.loading=!1,e.success?(this.feed.list=[...e.data],this.hasMore=!1,this.feed.list.length||this.exitSingleMode()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},loadMore(){this.feed.page++,this.getComments()},onPublish(e){this.feed.list.push(e),this.$refs.composer.reset(),this.$refs.composer.isFocused=!1,this.status.replies.count+=1,this.parentComment&&(this.parentComment.replies.count+=1)},onFlatReply(e){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();this.forceShowComposer=!0;const t=setInterval(()=>{this.$refs.composer&&(this.$refs.composer.focus(),"user"===e.publisher.type&&(this.$refs.composer.data.content=`@${e.publisher.username} `),clearInterval(t))},10)},exitSingleMode(){this.statusRef.showActiveComment=!1,this.$root.config.single_reply_id=null,this.feed.list=[],Voxel.deleteSearchParam("reply_id"),this.getComments()}},computed:{feedKey(){return this.parentComment?"comment:"+this.parentComment.id:"status:"+this.status.id}}},Comment_Single={template:"#vxfeed__comment",emits:["update","delete","flat-reply"],props:{status:Object,comment:Object,depth:Number,parentComment:{type:Object,default:null}},data(){return{screen:null,showActions:!1,showComments:!1,readMore:!1,maxDepth:this.$root.config.settings.replies.max_nest_level,state:{liking:!1,deleting:!1}}},methods:{onUpdate(e){this.screen=null,this.$emit("update",e)},writeReply(){if(this.showComments)this.showComments=!1;else{if(this.showComments=!0,!Voxel_Config.is_logged_in)return Voxel.authRequired();this.$nextTick(()=>{this.$refs.commentFeed.$refs.composer.focus()})}},deleteComment(){const e=()=>{this.state.deleting=!0,jQuery.post(Voxel_Config.ajax_url+"&action=timeline/v2/comment.delete",{comment_id:this.comment.id,_wpnonce:this.$root.config.nonce}).always(e=>{var t;this.state.deleting=!1,e.success?(t=this.comment.replies.count+1,Voxel.alert(e.message,"success",null,3e3),this.$emit("delete"),this.screen="deleted",this.comment._deleted=!0,this.status.replies.count-=t,this.parentComment&&--this.parentComment.replies.count):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})};Voxel.prompt(Voxel_Config.l10n.confirmAction,"warning",[{label:"Yes",onClick:()=>e()},{label:"No",onClick:()=>{}}],7500)},likeComment(){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();const t=this.$root.config.current_user;"unlike"==(this.comment.current_user.has_liked?"unlike":"like")?(--this.comment.likes.count,this.comment.current_user.has_liked=!1,this.comment.likes.last3=this.comment.likes.last3.filter(e=>!("user"===e.type&&e.id===t.id))):(this.comment.likes.count+=1,this.comment.current_user.has_liked=!0,this.comment.likes.last3.unshift({id:t.id,type:"user",display_name:t.display_name,link:t.link,avatar_url:t.avatar_url}),this.comment.likes.last3=this.comment.likes.last3.slice(0,3)),this.state.liking=!0,jQuery.post(Voxel_Config.ajax_url+"&action=timeline/v2/comment.like",{comment_id:this.comment.id,_wpnonce:this.$root.config.nonce}).always(e=>{this.state.liking=!1,e.success||Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},copyLink(){Voxel.copy(this.comment.link),this.showActions=!1},share(){Voxel.share({url:this.comment.link}),this.showActions=!1},markApproved(){this.showActions=!1,jQuery.post(Voxel_Config.ajax_url+"&action=timeline/v2/comment.mark_approved",{comment_id:this.comment.id,_wpnonce:this.$root.config.nonce}).always(e=>{e.success?(this.comment.is_pending=!1,this.comment.badges=e.badges):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},markPending(){this.showActions=!1,jQuery.post(Voxel_Config.ajax_url+"&action=timeline/v2/comment.mark_pending",{comment_id:this.comment.id,_wpnonce:this.$root.config.nonce}).always(e=>{e.success?(this.comment.is_pending=!0,this.comment.badges=e.badges):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}},computed:{highlightedContent(){return this.$root.highlightContent(this.comment.content)},truncatedContent(){return this.$root.truncate(this.highlightedContent,this.$root.config.settings.replies.truncate_at)}}},timelineComments={Comment_Composer:Comment_Composer,Comment_Feed:Comment_Feed,Comment_Single:Comment_Single};export{timelineComments as default};
