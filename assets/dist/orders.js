!function(e){"function"==typeof define&&define.amd?define("orders",e):e()}(function(){"use strict";var e={template:"#order-item-booking-details",props:{booking:Object,item:Object,order:Object,parent:Object},data(){return{picker:null,reschedule:{weekdays:["sun","mon","tue","wed","thu","fri","sat"],single_day:{date:null},timeslots:{date:null,slot:null,schedule:{}}}}},methods:{cancelBooking(){confirm(Voxel_Config.l10n.confirmAction)&&(this.parent.running_action=!0,jQuery.post(Voxel_Config.ajax_url+"&action=products.single_order.bookings.cancel_booking",{order_id:this.order.id,order_item_id:this.item.id,_wpnonce:this.parent.orders.config.nonce}).always(e=>{this.parent.running_action=!1,e.success||Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.parent.reload()}))},openCalendar(){this.$root.activePopup="booking-reschedule-"+this.order.id,this.picker?.destroy(),this.$nextTick(()=>{this.renderPicker(),document.body.dispatchEvent(new CustomEvent("scroll"))})},dateFormat(e){return Voxel.helpers.dateFormat(e)},_getBufferTime(){var e=this.booking.schedule.availability.buffer;return"hours"===e.unit?36e5*e.amount:864e5*e.amount},renderPicker(){let t=this.booking.schedule;var e=new Date(t.today.date+"T"+t.today.time+"Z"),r=new Date(e.getTime()+this._getBufferTime()),e=new Date(e.getTime()+864e5*(t.availability.max_days-1));r.setHours(0,0,0,0),e.setHours(0,0,0,0),"timeslots"===this.booking.type?(t.timeslots.groups.forEach(t=>{t.days.forEach(e=>{this.reschedule.timeslots.schedule[e]=t.slots})}),this.picker=new Pikaday({field:this.$refs.calendarInput?.[0],container:this.$refs.calendar?.[0],bound:!1,firstDay:1,keyboardInput:!1,numberOfMonths:1,minDate:r,maxDate:e,expandYears:!1,onSelect:e=>{this.reschedule.timeslots.date=e,this.reschedule.timeslots.slot=null},selectDayFn:e=>this.reschedule.timeslots.date&&this.reschedule.timeslots.date.toDateString()===e.toDateString(),disableDayFn:e=>{e=this.reschedule.timeslots.schedule[this.reschedule.weekdays[e.getDay()]];if(!Array.isArray(e)||!e.length)return!0},unavailableDayFn:e=>{if(t.excluded_days.includes(Voxel.helpers.dateFormatYmd(e)))return!0}})):this.picker=new Pikaday({field:this.$refs.calendarInput?.[0],container:this.$refs.calendar?.[0],bound:!1,firstDay:1,keyboardInput:!1,numberOfMonths:1,minDate:r,maxDate:e,expandYears:!1,onSelect:e=>{this.reschedule.single_day.date=e},selectDayFn:e=>this.reschedule.single_day.date&&this.reschedule.single_day.date.toDateString()===e.toDateString(),disableDayFn:e=>{e=this.reschedule.weekdays[e.getDay()];if(t.excluded_weekdays.includes(e))return!0},unavailableDayFn:e=>{if(t.excluded_days.includes(Voxel.helpers.dateFormatYmd(e)))return!0}})},confirmReschedule(){this.parent.running_action=!0;let e={};e="timeslots"===this.booking.type?{date:this.reschedule.timeslots.date?Voxel.helpers.dateFormatYmd(this.reschedule.timeslots.date):null,slot:{from:this.reschedule.timeslots.slot?.from||null,to:this.reschedule.timeslots.slot?.to||null}}:{date:this.reschedule.single_day.date?Voxel.helpers.dateFormatYmd(this.reschedule.single_day.date):null},jQuery.post(Voxel_Config.ajax_url+"&action=products.single_order.bookings.reschedule_booking",{order_id:this.order.id,order_item_id:this.item.id,reschedule_to:e,_wpnonce:this.parent.orders.config.nonce}).always(e=>{this.parent.running_action=!1,e.success?(this.clearReschedule(),this.parent.reload()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},blurReschedule(){this.reschedule.single_day={date:null},this.reschedule.timeslots={date:null,slot:null,schedule:{}}},clearReschedule(){this.blurReschedule(),this.$refs.bookingCalendar?.[0]?.blur()},getSlotLabel(e){return Voxel.helpers.timeFormat(new Date(`2020-01-01T${e.from}:00`))+" - "+Voxel.helpers.timeFormat(new Date(`2020-01-01T${e.to}:00`))}},computed:{currentDaySlots(){if("timeslots"!==this.booking.type)return[];var e=this.booking.schedule;let r=this.reschedule.timeslots.date;if(!r)return[];var t=new Date(e.today.date+"T"+e.today.time+"Z"),s=this.reschedule.timeslots.schedule[this.reschedule.weekdays[r.getDay()]];if(s.forEach(e=>e._disabled=!1),Voxel.helpers.dateFormatYmd(r)===Voxel.helpers.dateFormatYmd(t)){t=new Date(t.getTime()+this._getBufferTime());let r=parseInt(""+t.getUTCHours()+t.getUTCMinutes(),10);s.forEach(e=>{var t=e.from.split(":"),t=parseInt(""+t[0]+t[1],10);e._disabled=t<r})}let i=e.quantity_per_slot,a=e.booked_slot_counts;return s.forEach(e=>{var t=`${Voxel.helpers.dateFormatYmd(r)} ${e.from}-`+e.to;i-(a[t]||0)<1&&(e._disabled=!0)}),s}}},t={template:"#order-item-deliverables",props:{deliverables:Object,item:Object,order:Object,parent:Object},data(){return{new_uploads:[]}},methods:{uploadsUpdated(e){this.parent.running_action=!0;let t=new FormData;e.forEach(e=>{"new_upload"===e.source&&t.append("files[deliverables][]",e.item)});e=jQuery.param({action:"products.single_order.deliverables.upload",order_id:this.order.id,order_item_id:this.item.id,_wpnonce:this.$root.config.nonce});jQuery.post({url:Voxel_Config.ajax_url+"&"+e,data:t,contentType:!1,processData:!1}).always(e=>{this.parent.running_action=!1,e.success?(Voxel.alert(e.message,"success",3e3),this.parent.reload()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}),this.new_uploads.length=0},removeFile(e,t){this.parent.running_action=!0;e=jQuery.param({action:"products.single_order.deliverables.delete",order_id:this.order.id,order_item_id:this.item.id,file_id:e.id,group_index:t,_wpnonce:this.$root.config.nonce});jQuery.post(Voxel_Config.ajax_url+"&"+e).always(e=>{this.parent.running_action=!1,e.success?this.parent.reload():Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}}},r={template:"#order-shipping-details",props:{order:Object,parent:Object},data(){return{share_details:{tracking_link:this.order.shipping.tracking_details.link}}},methods:{markShipped(){this.parent.running_action=!0,jQuery.post(Voxel_Config.ajax_url+"&action=products.single_order.shipping.mark_as_shipped",{order_id:this.order.id,_wpnonce:this.parent.orders.config.nonce}).always(e=>{this.parent.running_action=!1,e.success||Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.parent.reload()})},markDelivered(){this.parent.running_action=!0,jQuery.post(Voxel_Config.ajax_url+"&action=products.single_order.shipping.mark_as_delivered",{order_id:this.order.id,_wpnonce:this.parent.orders.config.nonce}).always(e=>{this.parent.running_action=!1,e.success||Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.parent.reload()})},shareTrackingLink(){this.parent.running_action=!0,jQuery.post(Voxel_Config.ajax_url+"&action=products.single_order.shipping.share_details",{order_id:this.order.id,tracking_link:this.share_details.tracking_link,_wpnonce:this.parent.orders.config.nonce}).always(e=>{this.parent.running_action=!1,e.success?(this.parent.reload(),this.share_details.tracking_link=e.tracking_link,this.$refs.trackingLink?.blur()):(Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.parent.reload())})}},computed:{status(){return this.order.shipping.status}}},s={template:"#order-item-promotion-details",props:{item:Object,order:Object,parent:Object},data(){return{}},methods:{cancelPromotion(){confirm(Voxel_Config.l10n.confirmAction)&&(this.parent.running_action=!0,jQuery.post(Voxel_Config.ajax_url+"&action=products.single_order.promotions.cancel_promotion",{order_id:this.order.id,_wpnonce:this.parent.orders.config.nonce}).always(e=>{this.parent.running_action=!1,e.success||Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.parent.reload()}))}},computed:{details(){return this.item.details.promotion_package},hasDates(){return this.details.start_date&&this.details.end_date},getDates(){return this.details.start_date+" - "+this.details.end_date}}},a={template:"#orders-single",props:{order:Object,orders:Object},components:{itemBookingDetails:e,itemDeliverables:t,shippingDetails:r,itemPromotionDetails:s},data(){return{running_action:!1}},created(){},mounted(){window.scrollTo(0,0)},methods:{reload(){this.orders.reloadOrder(this.order.id)},goBack(){this.orders.order.id=null,this.orders.order.item=null,Voxel.deleteSearchParam("order_id"),Voxel.getSearchParam("parent_id")?this.$root.viewOrder(Voxel.getSearchParam("parent_id")):this.orders.query.is_initial_load&&this.orders.getInitialOrders()},replace_vars(t,r){return Object.keys(r).forEach(e=>{t=t.replaceAll(e,r[e])}),t},openConversation(){var e;this.isVendor()?((e=new URL(this.orders.config.messages.url)).searchParams.set("chat","u"+this.order.customer.id),e.searchParams.set("text",this.replace_vars(this.orders.config.messages.enquiry_text.vendor,{"@order_id":this.order.id})),window.location.href=e.toString()):((e=new URL(this.orders.config.messages.url)).searchParams.set("chat",this.order.actions.dms.vendor_target),e.searchParams.set("text",this.replace_vars(this.orders.config.messages.enquiry_text.customer,{"@order_id":this.order.id})),window.location.href=e.toString())},isVendor(){return this.order.current_user.id===this.order.vendor.id},isCustomer(){return this.order.current_user.id===this.order.customer.id},isAdmin(){return this.order.current_user.is_admin},getAction(e){for(var t of this.order.actions.primary)if(t.action===e)return t;for(var r of this.order.actions.secondary)if(r.action===e)return r;return null},runAction(e){"string"==typeof e.confirm&&!confirm(e.confirm)||(this.running_action=!0,jQuery.post(Voxel_Config.ajax_url+"&action=products.single_order.run_action",{order_id:this.order.id,_wpnonce:this.orders.config.nonce,order_action:e.action}).always(e=>{this.running_action=!1,e.success?e.redirect_to?window.location.href=e.redirect_to:this.reload():(Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.reload())}),this.$refs.actions?.blur())},truncate(e){var t=document.createElement("div");t.innerHTML=e;let r=this.orders.config.data_inputs.content_length,s=!1,i=0,a=e=>{var t;s?e.remove():(t=Array.from(e.childNodes)).length?t.forEach(e=>a(e)):(i+=e.textContent.length)>=r&&(s=!0,i>r&&(e.textContent=e.textContent.slice(0,-(i-r))),e.textContent+="…")};return a(t),{content:t.innerHTML,exists:s}}},computed:{dataInputs(){let s={};return this.order.items.forEach(e=>{var t=e.data_inputs_markup,r=this.truncate(t);s[e.id]={content:t,truncated:r}}),s}}},o={template:"#vx-file-upload",props:{field:Object,sortable:{type:Boolean,default:!0},allowedFileTypes:String,maxFileCount:{type:Number,default:1},modelValue:Array,context:Object},emits:["update:modelValue"],data(){return{dragActive:!1,reordering:!1,value:this.modelValue,id:"file-upload-"+Voxel.helpers.sequentialId()}},mounted(){jQuery(this.$refs.input).on("change",e=>{for(var t=0;t<e.target.files.length;t++){var r=e.target.files[t];this.pushFile(r)}this.$refs.input.value="",this.update()})},unmounted(){setTimeout(()=>{Array.isArray(this.value)&&this.value.forEach(e=>{"new_upload"===e.source&&URL.revokeObjectURL(e.preview)})},10)},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},pushFile(t){1===this.maxFileCount&&(this.value=[]);var e={source:"new_upload",name:t.name,type:t.type,size:t.size,preview:URL.createObjectURL(t),item:t,_id:Voxel.helpers.randomId(8)},r=(void 0===window._vx_file_upload_cache&&(window._vx_file_upload_cache=[]),window._vx_file_upload_cache.find(e=>e.item.name===t.name&&e.item.type===t.type&&e.item.size===t.size&&e.item.lastModified===t.lastModified));r?this.value.push(r):(this.value.push(e),window._vx_file_upload_cache.unshift(e))},onDrop(e){this.dragActive=!1,e.dataTransfer.items?[...e.dataTransfer.items].forEach(e=>{"file"===e.kind&&this.pushFile(e.getAsFile())}):[...e.dataTransfer.files].forEach(e=>{this.pushFile(e)}),this.update()},onMediaPopupSave(e){1===this.maxFileCount&&(this.value=[]);var t={};this.value.forEach(e=>{"existing"===e.source&&(t[e.id]=!0),"new_upload"===e.source&&(t[e._id]=!0)}),Object.values(e).forEach(e=>{"existing"!==e.source||t[e.id]||this.value.push(e),"new_upload"!==e.source||t[e._id]||this.value.push(e)}),this.update()},update(){this.$emit("update:modelValue",this.value)}},watch:{modelValue(e){this.value=e}}};window.render_orders=()=>{Array.from(document.querySelectorAll(".vx-orders-widget")).forEach(e=>{var t,i;e.__vue_app__||(t=JSON.parse(e.dataset.config),i=t,(t=Vue.createApp({el:e,mixins:[Voxel.mixins.base],data(){return{config:i,activePopup:null,query:{is_initial_load:!0,pg:1,status:"all",shipping_status:"all",search:"",loading:!0,has_more:!1,items:[]},order:{id:null,loading:!1,item:null}}},created(){window.VX_Orders=this;var e=parseInt(Voxel.getSearchParam("order_id"),10);!isNaN(e)&&0<e?this.viewOrder(e):this.getInitialOrders()},methods:{getInitialOrders(){var e=parseInt(Voxel.getSearchParam("pg"),10),t=Voxel.getSearchParam("status"),r=Voxel.getSearchParam("shipping_status"),s=Voxel.getSearchParam("search");1<e&&(this.query.pg=e),"string"==typeof t&&i.statuses[t]&&(this.query.status=t),"string"==typeof r&&i.shipping_statuses[r]&&(this.query.shipping_status=r),"string"==typeof s&&s.trim().length&&(this.query.search=s.trim()),this.getOrders()},getOrders(){1<this.query.pg?Voxel.setSearchParam("pg",this.query.pg):Voxel.deleteSearchParam("pg"),"all"!==this.query.status?Voxel.setSearchParam("status",this.query.status):Voxel.deleteSearchParam("status"),"all"!==this.query.shipping_status?Voxel.setSearchParam("shipping_status",this.query.shipping_status):Voxel.deleteSearchParam("shipping_status"),this.query.search?.length?Voxel.setSearchParam("search",this.query.search):Voxel.deleteSearchParam("search"),this.query.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=products.orders.list",{pg:this.query.pg,status:this.query.status,shipping_status:this.query.shipping_status,search:this.query.search}).always(e=>{this.query.loading=!1,this.query.is_initial_load=!1,e.success?(this.query.items=e.items,this.query.has_more=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},nextPage(){this.query.pg+=1,this.getOrders()},previousPage(){--this.query.pg,this.query.pg<1&&(this.query.pg=1),this.getOrders()},setStatus(e){this.query.status!==e&&(this.query.status=e,this.query.pg=1,this.getOrders())},setShippingStatus(e){this.query.shipping_status!==e&&(this.query.shipping_status=e,this.query.pg=1,this.getOrders())},setSearch(e){this.query.search!==e&&(this.query.search=e,this.query.pg=1,this.getOrders())},resetFilters(){""===this.query.search&&"all"===this.query.status&&"all"===this.query.shipping_status&&1===this.query.pg||(this.query.search="",this.query.status="all",this.query.shipping_status="all",this.query.pg=1,this.getOrders())},currencyFormat(){return Voxel.helpers.currencyFormat(...arguments)},viewOrder(e,t=null){this.order.id=e,this.order.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=products.single_order.get",{order_id:this.order.id}).always(e=>{this.order.loading=!1,e.success?(this.order.item=e.order,Voxel.setSearchParam("order_id",e.order.id),Voxel.deleteSearchParam("parent_id"),null!==t&&Voxel.setSearchParam("parent_id",t)):(Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),Voxel.deleteSearchParam("order_id"),Voxel.deleteSearchParam("parent_id"),this.order.id=null,this.order.item=null,this.order.loading=!1,this.getInitialOrders())})},reloadOrder(e){this.order.id=e,this.order.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=products.single_order.get",{order_id:this.order.id}).always(t=>{var e;this.order.loading=!1,t.success?(this.order.item=t.order,(e=this.query.items.find(e=>e.id===t.order.id))&&(e.status=t.order.status.key,e.shipping_status=t.order.shipping.status?.key||null)):Voxel.alert(t.message||Voxel_Config.l10n.ajaxError,"error")})}},computed:{$w(){return window}}})).component("form-popup",Voxel.components.popup),t.component("form-group",Voxel.components.formGroup),t.component("single-order",a),t.component("file-upload",o),t.mount(e))})},window.render_orders(),jQuery(document).on("voxel:markup-update",window.render_orders)});
